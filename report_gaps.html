<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ê²©ì°¨ ë¶„ì„ Â· ElectionAI</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.gap-table td.gap-cell { font-weight: 700; font-size: 13px; }
.gap-positive { color: #dc2626; }
.gap-neutral { color: #d97706; }
.gap-negative { color: #16a34a; }

.gap-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.gap-label { width: 90px; font-size: 12px; font-weight: 600; flex-shrink: 0; }
.gap-track { flex: 1; height: 10px; background: #f1f5f9; border-radius: 5px; overflow: hidden; position: relative; }
.gap-fill { height: 100%; border-radius: 5px; }
.gap-val { width: 36px; text-align: right; font-size: 12px; font-weight: 700; }

.winner-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;
  color: white;
}
.strength-card {
  background: white; border-radius: var(--radius-sm); padding: 14px 16px;
  border: 1px solid var(--border); margin-bottom: 10px;
}
</style>
</head>
<body>

<header class="app-header">
  <div class="header-inner">
    <div class="header-logo">âš–ï¸ Election<span>AI</span></div>
    <div class="header-subtitle">AI ê¸°ë°˜ ì„ ê±° í›„ë³´ì ë¹„êµ ë¶„ì„ í”Œë«í¼</div>
    <div class="header-date" id="header-date"></div>
  </div>
</header>
<nav class="main-nav"><div class="nav-inner" id="main-nav"></div></nav>

<div class="page-container">
  <div class="page-title">
    <h1>ğŸ¯ ê²©ì°¨ ë¶„ì„</h1>
    <p>1ìœ„ í›„ë³´ ëŒ€ë¹„ í•­ëª©ë³„ ì ìˆ˜ ê²©ì°¨ ë° ê²½ìŸ êµ¬ì¡° ë¶„ì„</p>
  </div>
  <div id="page-content"></div>
</div>

<button class="print-btn" onclick="window.open('report_full.html','_blank')" title="ì „ì²´ PDF ë³´ê³ ì„œ">ğŸ“¥</button>

<script src="js/shared.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const data = requireData();
  if (!data) return;

  const { candidates } = data;
  const sorted = [...candidates].map((c,i)=>({...c,idx:i})).sort((a,b)=>b.total_score-a.total_score);
  const leader = sorted[0];
  const leaderCol = CANDIDATE_COLORS[leader.idx % 5];
  const n = candidates.length;
  let html = '';

  // â”€â”€ ë¦¬ë” ìš”ì•½ â”€â”€
  html += `<div class="card">
    <div class="card-title">ğŸ¥‡ ê¸°ì¤€ í›„ë³´ (ì¢…í•© 1ìœ„)</div>
    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
      <div class="winner-badge" style="background:${leaderCol.border}">
        ğŸ† ${leader.name} Â· ${leader.total_score}ì 
      </div>
      <div style="font-size:13px;color:var(--text-muted)">${leader.party} Â· ${leader.position || ''}</div>
    </div>
    <div class="insight-box" style="margin-top:12px">
      ì•„ë˜ ëª¨ë“  ê²©ì°¨ëŠ” <strong>${leader.name}(${leader.total_score}ì )</strong>ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
      ì–‘ìˆ˜(+)ëŠ” ë¦¬ë”ë³´ë‹¤ ë†’ì€ í•­ëª©, ìŒìˆ˜(-)ëŠ” ë‚®ì€ í•­ëª©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
    </div>
  </div>`;

  // â”€â”€ ì¢…í•© ì ìˆ˜ ê²©ì°¨ â”€â”€
  html += `<div class="card"><div class="card-title">ğŸ“‰ ì¢…í•© ì ìˆ˜ ê²©ì°¨</div>
    <div class="table-wrap"><table>
      <thead><tr><th>ìˆœìœ„</th><th>í›„ë³´ì</th><th>ì¢…í•© ì ìˆ˜</th><th>ê²©ì°¨</th><th>ë¹„ìœ¨</th></tr></thead>
      <tbody>`;
  sorted.forEach((c, rank) => {
    const gap = c.total_score - leader.total_score;
    const pct = ((c.total_score / leader.total_score) * 100).toFixed(1);
    const col = CANDIDATE_COLORS[c.idx % 5];
    html += `<tr>
      <td>${rankTag(rank+1)}</td>
      <td style="color:${col.border};font-weight:700">${c.name}</td>
      <td style="font-weight:800;font-size:15px">${c.total_score}ì </td>
      <td class="${gap===0?'':gap>0?'gap-positive':'gap-neutral'}" style="font-weight:700;font-size:14px">
        ${gap === 0 ? 'ê¸°ì¤€' : (gap > 0 ? '+' : '') + gap + 'ì '}
      </td>
      <td>${pct}%</td>
    </tr>`;
  });
  html += `</tbody></table></div></div>`;

  // â”€â”€ í•­ëª©ë³„ ê²©ì°¨ ì°¨íŠ¸ (ë¦¬ë” ëŒ€ë¹„) â”€â”€
  html += `<div class="card"><div class="card-title">ğŸ“Š í•­ëª©ë³„ ê²©ì°¨ ì°¨íŠ¸ (1ìœ„ ëŒ€ë¹„)</div>
    <div class="chart-container" style="height:${40+40*METRICS.length}px">
      <canvas id="gapChart"></canvas>
    </div></div>`;

  // â”€â”€ í›„ë³´ë³„ ê²©ì°¨ í…Œì´ë¸” â”€â”€
  html += `<div class="card"><div class="card-title">ğŸ“‹ í›„ë³´ë³„ í•­ëª©ë³„ ê²©ì°¨ ìƒì„¸ (1ìœ„ ëŒ€ë¹„)</div>
    <div class="table-wrap"><table>
      <thead><tr><th>í•­ëª©</th><th>${leader.name} (ê¸°ì¤€)</th>`;
  sorted.slice(1).forEach(c => { html += `<th style="color:${CANDIDATE_COLORS[c.idx%5].border}">${c.name} ê²©ì°¨</th>`; });
  html += `<th>ìµœëŒ€ ê²©ì°¨</th></tr></thead><tbody>`;

  METRICS.forEach(m => {
    const leaderScore = leader.metrics?.[m] ?? 0;
    const gaps = sorted.slice(1).map(c => (c.metrics?.[m] ?? 0) - leaderScore);
    const maxGap = Math.max(...gaps.map(g => Math.abs(g)));
    html += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td>
      <td style="font-weight:700">${leaderScore}</td>`;
    sorted.slice(1).forEach((c, ii) => {
      const g = gaps[ii];
      const cls = g > 0 ? 'gap-positive' : g < 0 ? 'gap-neutral' : '';
      html += `<td class="${cls}">${g > 0 ? '+' + g : g}</td>`;
    });
    html += `<td style="font-weight:700">${maxGap}ì </td></tr>`;
  });
  html += `</tbody></table></div></div>`;

  // â”€â”€ ê²½ìŸ ìš°ìœ„ ë§¤íŠ¸ë¦­ìŠ¤ â”€â”€
  if (n >= 2) {
    html += `<div class="card"><div class="card-title">âš”ï¸ í•­ëª©ë³„ ê²½ìŸ ìš°ìœ„ ë§¤íŠ¸ë¦­ìŠ¤</div>
      <div class="table-wrap"><table>
        <thead><tr><th>í•­ëª©</th><th>1ìœ„ í›„ë³´</th><th>ìš°ìœ„ ì ìˆ˜</th><th>ê²½ìŸ ê°•ë„</th></tr></thead><tbody>`;
    METRICS.forEach(m => {
      const scores = candidates.map((c,i) => ({ name:c.name, score:c.metrics?.[m]??0, col:CANDIDATE_COLORS[i%5] }));
      scores.sort((a,b)=>b.score-a.score);
      const top = scores[0];
      const gap = scores[0].score - scores[1].score;
      const intensity = gap <= 1 ? 'ğŸ”´ ë§¤ìš° ì¹˜ì—´' : gap <= 3 ? 'ğŸŸ¡ ì¹˜ì—´' : gap <= 6 ? 'ğŸŸ¢ ìš°ì„¸' : 'ğŸ”µ ì••ë„ì ';
      html += `<tr>
        <td><strong>${METRIC_LABELS[m]}</strong></td>
        <td style="color:${top.col.border};font-weight:700">${top.name}</td>
        <td style="font-weight:700">+${gap}ì </td>
        <td>${intensity}</td>
      </tr>`;
    });
    html += `</tbody></table></div></div>`;
  }

  // â”€â”€ ì¸ì‚¬ì´íŠ¸ â”€â”€
  const biggestGapMetric = METRICS.reduce((best, m) => {
    const scores = candidates.map(c => c.metrics?.[m] ?? 0);
    const gap = Math.max(...scores) - Math.min(...scores);
    return gap > best.gap ? { m, gap } : best;
  }, { m: '', gap: 0 });

  const smallestGapMetric = METRICS.reduce((best, m) => {
    const scores = candidates.map(c => c.metrics?.[m] ?? 0);
    const gap = Math.max(...scores) - Math.min(...scores);
    return gap < best.gap ? { m, gap } : best;
  }, { m: METRICS[0], gap: 999 });

  html += `<div class="card"><div class="card-title">ğŸ’¡ ê²©ì°¨ ì¸ì‚¬ì´íŠ¸</div>
    <div class="insight-box">
      <strong>ê°€ì¥ í° ê²©ì°¨ í•­ëª©:</strong> ${METRIC_LABELS[biggestGapMetric.m]} (${biggestGapMetric.gap}ì  ì°¨ì´) â€” í›„ë³´ ê°„ ì—­ëŸ‰ ì°¨ì´ê°€ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤.<br>
      <strong>ê°€ì¥ ì‘ì€ ê²©ì°¨ í•­ëª©:</strong> ${METRIC_LABELS[smallestGapMetric.m]} (${smallestGapMetric.gap}ì  ì°¨ì´) â€” í›„ë³´ ê°„ ê²½ìŸì´ ê°€ì¥ ì¹˜ì—´í•œ ì˜ì—­ì…ë‹ˆë‹¤.<br>
      <strong>1ìœ„~ìµœí•˜ìœ„ ì¢…í•© ê²©ì°¨:</strong> ${leader.total_score - sorted[n-1].total_score}ì 
    </div>
  </div>`;

  document.getElementById('page-content').innerHTML = html;

  // â”€â”€ ê²©ì°¨ ì°¨íŠ¸ ë Œë”ë§ â”€â”€
  const datasets = sorted.slice(1).map((c, idx) => ({
    label: c.name,
    data: METRICS.map(m => (c.metrics?.[m] ?? 0) - (leader.metrics?.[m] ?? 0)),
    backgroundColor: CANDIDATE_COLORS[c.idx % 5].bg,
    borderColor: CANDIDATE_COLORS[c.idx % 5].border,
    borderWidth: 2,
    borderRadius: 4,
  }));

  new Chart(document.getElementById('gapChart'), {
    type: 'bar',
    data: { labels: METRICS.map(m => METRIC_LABELS[m]), datasets },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      scales: {
        x: {
          ticks: { callback: v => v > 0 ? '+' + v : v, font: { size: 11 } },
          grid: { color: ctx => ctx.tick.value === 0 ? '#94a3b8' : '#f1f5f9' }
        },
        y: { ticks: { font: { size: 12 } } }
      },
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 16 } },
        tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.x > 0 ? '+' + ctx.parsed.x : ctx.parsed.x}ì ` } }
      }
    }
  });
});
</script>
</body>
</html>
