<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì„ ê±° í›„ë³´ì ë¹„êµ ë¶„ì„ í”Œë«í¼</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
.setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.step-badge {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--primary); color: white; font-weight: 700; font-size: 13px;
  margin-right: 8px; flex-shrink: 0;
}
.step-title { font-size: 16px; font-weight: 700; color: var(--primary-dark); margin-bottom: 14px; display: flex; align-items: center; }
.input-wrap { display: flex; gap: 8px; }
.input-wrap input, .form-input {
  flex: 1; padding: 10px 14px; border: 2px solid var(--border);
  border-radius: var(--radius-sm); font-family: inherit; font-size: 14px;
  outline: none; transition: border-color 0.2s;
}
.input-wrap input:focus, .form-input:focus { border-color: var(--primary-light); }
.api-status { font-size: 12px; margin-top: 6px; }
.api-ok { color: var(--success); } .api-none { color: var(--text-muted); }

/* ë“œë¡­ì¡´ */
.drop-zone {
  border: 2px dashed var(--primary-light);
  border-radius: var(--radius);
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: #f0f7ff;
}
.drop-zone:hover, .drop-zone.drag-over { background: #dbeafe; border-color: var(--primary); }
.drop-zone .drop-icon { font-size: 40px; margin-bottom: 12px; }
.drop-zone h3 { color: var(--primary); font-size: 16px; margin-bottom: 6px; }
.drop-zone p { color: var(--text-muted); font-size: 13px; }
#fileInput { display: none; }

/* íŒŒì¼ ëª©ë¡ */
.file-list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
.file-item {
  display: flex; align-items: center; gap: 10px;
  background: white; border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 14px;
}
.file-icon { font-size: 20px; flex-shrink: 0; }
.file-name { flex: 1; font-weight: 500; font-size: 13px; }
.file-size { color: var(--text-muted); font-size: 12px; }
.file-remove { background: none; border: none; cursor: pointer; color: var(--danger); font-size: 16px; padding: 2px 6px; }

/* ë¶„ì„ ë²„íŠ¼ */
.analyze-area { margin-top: 20px; display: flex; align-items: center; gap: 16px; }
#analyzeBtn { padding: 12px 32px; font-size: 15px; }

/* ì§„í–‰ ìƒíƒœ */
.status-log {
  margin-top: 16px; background: #0f172a; border-radius: var(--radius-sm);
  padding: 14px 16px; max-height: 160px; overflow-y: auto;
  display: none;
}
.status-line { color: #94a3b8; font-size: 13px; font-family: monospace; padding: 2px 0; }
.status-line.ok { color: #4ade80; }
.status-line.err { color: #f87171; }
.status-line.info { color: #60a5fa; }

/* ê²°ê³¼ ì¹´ë“œ */
.result-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap: 14px; margin-top: 16px; }
.result-nav-card {
  background: white; border-radius: var(--radius); border: 1px solid var(--border);
  padding: 20px 16px; text-align: center; text-decoration: none;
  color: var(--text); box-shadow: var(--shadow); transition: all 0.2s;
}
.result-nav-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--primary-light); }
.result-nav-card .nav-icon { font-size: 28px; margin-bottom: 8px; }
.result-nav-card .nav-label { font-size: 13px; font-weight: 600; color: var(--primary-dark); }

/* ì €ì¥ëœ ë°ì´í„° ìš”ì•½ */
.saved-summary {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border: 1px solid #bfdbfe; border-radius: var(--radius);
  padding: 16px 20px; display: flex; align-items: center; gap: 16px;
}
.saved-candidate-tags { display: flex; flex-wrap: wrap; gap: 6px; }
.saved-tag {
  padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
  background: white; border: 1px solid var(--border);
}

/* ì „ëµ ë³´ê³ ì„œ í›„ë³´ ì„ íƒ */
.strategy-select-section {
  margin-top: 20px;
  background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
  border-radius: var(--radius); padding: 24px 28px; color: white;
}
.strategy-select-section h3 { font-size: 18px; font-weight: 800; margin-bottom: 6px; }
.strategy-select-section p { font-size: 13px; opacity: .8; margin-bottom: 18px; }
.strategy-candidate-btns { display: flex; flex-wrap: wrap; gap: 10px; }
.strategy-candidate-btn {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,255,255,0.12); border: 2px solid rgba(255,255,255,0.3);
  color: white; border-radius: 12px; padding: 12px 20px;
  cursor: pointer; font-family: inherit; font-size: 14px; font-weight: 700;
  transition: all 0.2s; text-decoration: none;
}
.strategy-candidate-btn:hover {
  background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.7);
  transform: translateY(-2px);
}
.strategy-candidate-btn .sc-rank { font-size: 18px; }
.strategy-candidate-btn .sc-info { text-align: left; }
.strategy-candidate-btn .sc-name { font-size: 15px; font-weight: 800; }
.strategy-candidate-btn .sc-score { font-size: 11px; opacity: .75; }

@media (max-width: 768px) { .setup-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header class="app-header">
  <div class="header-inner">
    <div class="header-logo">âš–ï¸ Election<span>AI</span></div>
    <div class="header-subtitle">AI ê¸°ë°˜ ì„ ê±° í›„ë³´ì ë¹„êµ ë¶„ì„ í”Œë«í¼</div>
    <div class="header-date" id="header-date"></div>
  </div>
</header>
<nav class="main-nav"><div class="nav-inner" id="main-nav"></div></nav>

<div class="page-container">

  <div class="page-title">
    <h1>í›„ë³´ì ë¶„ì„ ì‹œì‘</h1>
    <p>PoliticianFinder.com AI í‰ê°€ ë¦¬í¬íŠ¸ PDFë¥¼ ì—…ë¡œë“œí•˜ë©´ 10ê°œ ì§€í‘œ ë¹„êµ ë¶„ì„ ë³´ê³ ì„œë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.</p>
  </div>

  <!-- ì €ì¥ëœ ë°ì´í„°ê°€ ìˆì„ ê²½ìš° -->
  <div id="saved-data-section" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“‹ ì €ì¥ëœ ë¶„ì„ ë°ì´í„°</div>
      <div class="saved-summary" id="saved-summary"></div>
      <div class="result-cards" id="result-cards">
        <a href="report_compare.html" class="result-nav-card"><div class="nav-icon">ğŸ“Š</div><div class="nav-label">ì¢…í•© ë¹„êµ</div></a>
        <a href="report_scores.html" class="result-nav-card"><div class="nav-icon">ğŸ“ˆ</div><div class="nav-label">ì ìˆ˜ ìƒì„¸</div></a>
        <a href="report_profiles.html" class="result-nav-card"><div class="nav-icon">ğŸ‘¤</div><div class="nav-label">í›„ë³´ í”„ë¡œíŒŒì¼</div></a>
        <a href="report_gaps.html" class="result-nav-card"><div class="nav-icon">ğŸ¯</div><div class="nav-label">ê²©ì°¨ ë¶„ì„</div></a>
        <a href="report_ai.html" class="result-nav-card"><div class="nav-icon">ğŸ¤–</div><div class="nav-label">AI ëª¨ë¸ ë¹„êµ</div></a>
      </div>

      <!-- ì „ëµ ë³´ê³ ì„œ í›„ë³´ ì„ íƒ -->
      <div class="strategy-select-section">
        <h3>ğŸ† ë‹¹ì„  ì „ëµ ë³´ê³ ì„œ â€” í›„ë³´ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        <p>ì•„ë˜ í›„ë³´ ì¤‘ ì „ëµ ë³´ê³ ì„œë¥¼ ì‘ì„±í•  ëŒ€ìƒì„ ì„ íƒí•˜ë©´, í•´ë‹¹ í›„ë³´ë§Œì„ ìœ„í•œ<br>
           <strong>AI ì„ ê±° ì „ëµ ì¸í…”ë¦¬ì „ìŠ¤ ë¦¬í¬íŠ¸</strong>ê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
        <div class="strategy-candidate-btns" id="strategyBtns"></div>
      </div>

      <div style="margin-top:14px">
        <button class="btn btn-outline btn-sm" onclick="clearData()">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™” í›„ ìƒˆ ë¶„ì„</button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ì˜ì—­ -->
  <div class="setup-grid">

    <!-- Step 1: API í‚¤ -->
    <div class="card">
      <div class="step-title"><span class="step-badge">1</span>Google Gemini API í‚¤ ì„¤ì •</div>
      <div class="input-wrap">
        <input type="password" id="apiKeyInput" placeholder="AIzaSy..." autocomplete="off">
        <button class="btn btn-primary" onclick="saveApiKey()">ì €ì¥</button>
      </div>
      <div class="api-status" id="apiStatus">
        <span class="api-none">â— API í‚¤ ë¯¸ì„¤ì •</span>
      </div>
      <div class="alert alert-info" style="margin-top:12px;font-size:12px">
        ğŸ”‘ API í‚¤ëŠ” ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:inherit;font-weight:600">Google AI Studioì—ì„œ ë°œê¸‰ë°›ê¸° â†’</a>
      </div>
    </div>

    <!-- Step 2: ì„ ê±°êµ¬ -->
    <div class="card">
      <div class="step-title"><span class="step-badge">2</span>ì„ ê±°êµ¬ ë° ë¶„ì„ ì •ë³´</div>
      <label style="font-size:13px;color:var(--text-muted);margin-bottom:4px;display:block">ì„ ê±°êµ¬ ì´ë¦„</label>
      <input class="form-input" type="text" id="districtName" placeholder="ì˜ˆ: ì„œìš¸ ì„±ë™êµ¬" style="width:100%;margin-bottom:12px">
      <label style="font-size:13px;color:var(--text-muted);margin-bottom:4px;display:block">ì„ ê±° ìœ í˜•</label>
      <input class="form-input" type="text" id="electionType" placeholder="ì˜ˆ: ì œ9íšŒ ì „êµ­ë™ì‹œì§€ë°©ì„ ê±°" style="width:100%">
    </div>

  </div>

  <!-- Step 3: íŒŒì¼ ì—…ë¡œë“œ -->
  <div class="card">
    <div class="step-title"><span class="step-badge">3</span>í›„ë³´ì PDF ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (ìµœëŒ€ 5ëª…)</div>

    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <div class="drop-icon">ğŸ“„</div>
      <h3>PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</h3>
      <p>PoliticianFinder.com í‰ê°€ ë¦¬í¬íŠ¸ PDF Â· í›„ë³´ìë‹¹ 1ê°œ íŒŒì¼ Â· ìµœëŒ€ 5ê°œ</p>
      <input type="file" id="fileInput" multiple accept=".pdf">
    </div>

    <div class="file-list" id="fileList"></div>

    <div class="analyze-area">
      <button class="btn btn-primary" id="analyzeBtn" onclick="startAnalysis()" disabled>
        ğŸ” ë¶„ì„ ì‹œì‘
      </button>
      <span id="analyzeHint" style="font-size:13px;color:var(--text-muted)">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</span>
    </div>

    <div class="status-log" id="statusLog"></div>
  </div>

  <!-- ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ -->
  <div class="card">
    <div class="card-title">âœï¸ ìˆ˜ë™ ë°ì´í„° ì…ë ¥ (PDF ì—†ì´ ì§ì ‘ ì…ë ¥)</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px">
      PDF ì¶”ì¶œì´ ì•ˆ ë  ê²½ìš°, ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
    <textarea id="manualInput" rows="6" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:monospace;font-size:12px;resize:vertical;outline:none"
      placeholder='[{"name":"í›„ë³´ìëª…","party":"ì •ë‹¹","position":"ì§ì±…","total_score":785,"ai_scores":{"claude":773,"chatgpt":780,"gemini":812,"grok":771},"metrics":{"ê³µìµì„±":83,"ì •ì±…ì‹¤í–‰ë ¥":81,"ì „ë¬¸ì„±":81,"ëŒ€ì‘ì„±":82,"ì±…ì„ì„±":81,"ì†Œí†µëŠ¥ë ¥":81,"ë¦¬ë”ì‹­":79,"ë¹„ì „ëª…í™•ì„±":76,"ì²­ë ´ì„±":73,"ìœ¤ë¦¬ì„±":69},"strengths":["ê°•ì 1","ê°•ì 2"],"weaknesses":["ì•½ì 1"],"summary":"ìš”ì•½"}]'></textarea>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn btn-outline" onclick="loadManualData()">ğŸ“¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-outline btn-sm" onclick="loadSampleData()">ğŸ“‹ ìƒ˜í”Œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
  </div>

</div>

<script src="js/shared.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let selectedFiles = [];

// â”€â”€ ì´ˆê¸°í™” â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const key = getApiKey();
  if (key) {
    document.getElementById('apiKeyInput').value = key.substring(0, 12) + '***';
    document.getElementById('apiStatus').innerHTML = '<span class="api-ok">âœ“ API í‚¤ ì €ì¥ë¨</span>';
  }
  checkSavedData();
  setupDropZone();
});

function checkSavedData() {
  const data = getData();
  if (data && data.candidates && data.candidates.length > 0) {
    const sec = document.getElementById('saved-data-section');
    sec.style.display = 'block';

    // ìš”ì•½ íƒœê·¸
    const tags = data.candidates.map((c,i) =>
      `<span class="saved-tag" style="border-color:${CANDIDATE_COLORS[i%5].border};color:${CANDIDATE_COLORS[i%5].text}">${c.name} (${c.total_score}ì )</span>`
    ).join('');
    document.getElementById('saved-summary').innerHTML =
      `<div style="font-size:22px">ğŸ“Š</div><div><div style="font-weight:700;margin-bottom:6px">${data.district || 'ì„ ê±°êµ¬'} Â· ${data.candidates.length}ëª… ë¶„ì„ ì™„ë£Œ</div><div class="saved-candidate-tags">${tags}</div></div>`;

    // ì „ëµ ë³´ê³ ì„œ í›„ë³´ ì„ íƒ ë²„íŠ¼
    const sorted = [...data.candidates]
      .map((c,i) => ({...c, origIdx: i}))
      .sort((a,b) => b.total_score - a.total_score);

    const rankEmoji = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'];
    const strategyLabel = ['1ìœ„ ìœ ì§€ ë°©ì–´ ì „ëµ','ì—­ì „ ì¶”ê²© ì „ëµ','í¬ì§€ì…˜ ë¦¬ë¹Œë”© ì „ëµ','í¬ì§€ì…˜ ë¦¬ë¹Œë”© ì „ëµ','í¬ì§€ì…˜ ë¦¬ë¹Œë”© ì „ëµ'];
    const btns = sorted.map((c, rank) => {
      const col = CANDIDATE_COLORS[c.origIdx % 5];
      return `<a href="report_strategy.html" class="strategy-candidate-btn"
          onclick="setTargetIdx(${c.origIdx})"
          style="border-color:${col.border}88">
          <span class="sc-rank">${rankEmoji[rank]}</span>
          <div class="sc-info">
            <div class="sc-name">${c.name}</div>
            <div class="sc-score">${c.total_score}ì  Â· ${strategyLabel[rank]}</div>
          </div>
        </a>`;
    }).join('');
    document.getElementById('strategyBtns').innerHTML = btns;
  }
}

// â”€â”€ API í‚¤ ì €ì¥ â”€â”€
function saveApiKey() {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val || val.includes('***')) return alert('ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  setApiKey(val);
  document.getElementById('apiKeyInput').value = val.substring(0, 12) + '***';
  document.getElementById('apiStatus').innerHTML = '<span class="api-ok">âœ“ API í‚¤ ì €ì¥ë¨</span>';
}

// â”€â”€ ë“œë¡­ì¡´ ì„¤ì • â”€â”€
function setupDropZone() {
  const zone = document.getElementById('dropZone');
  const input = document.getElementById('fileInput');

  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    addFiles([...e.dataTransfer.files]);
  });
  input.addEventListener('change', () => { addFiles([...input.files]); input.value = ''; });
}

function addFiles(files) {
  for (const f of files) {
    if (!f.name.toLowerCase().endsWith('.pdf')) { alert(`${f.name}: PDF íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.`); continue; }
    if (selectedFiles.length >= 5) { alert('ìµœëŒ€ 5ê°œ íŒŒì¼ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); break; }
    if (selectedFiles.some(s => s.name === f.name)) continue;
    selectedFiles.push(f);
  }
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('fileList');
  const btn = document.getElementById('analyzeBtn');
  const hint = document.getElementById('analyzeHint');
  list.innerHTML = selectedFiles.map((f,i) => `
    <div class="file-item">
      <span class="file-icon">ğŸ“„</span>
      <span class="file-name">${f.name}</span>
      <span class="file-size">${(f.size/1024).toFixed(1)} KB</span>
      <button class="file-remove" onclick="removeFile(${i})">âœ•</button>
    </div>`).join('');
  btn.disabled = selectedFiles.length === 0;
  hint.textContent = selectedFiles.length > 0
    ? `${selectedFiles.length}ê°œ íŒŒì¼ ì„ íƒë¨ Â· ë¶„ì„ ì‹œì‘ì„ í´ë¦­í•˜ì„¸ìš”.`
    : 'PDF íŒŒì¼ì„ ì—…ë¡œë“œí•œ í›„ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.';
}

function removeFile(i) {
  selectedFiles.splice(i, 1);
  renderFileList();
}

// â”€â”€ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ â”€â”€
async function extractTextFromPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(item => item.str).join(' ') + '\n';
  }
  return text.trim();
}

// â”€â”€ Gemini API í˜¸ì¶œ â”€â”€
async function analyzeWithGemini(text, apiKey) {
  const prompt = `ë‹¤ìŒì€ PoliticianFinder.comì˜ AI ì •ì¹˜ì¸ í‰ê°€ ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
ì´ í…ìŠ¤íŠ¸ì—ì„œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì •í™•íˆ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

ê·œì¹™:
- "ì •ì±…ì‹¤í–‰ë ¥"ì´ ì—†ìœ¼ë©´: ê³µìµì„±Ã—0.4 + ëŒ€ì‘ì„±Ã—0.3 + ì „ë¬¸ì„±Ã—0.3 ìœ¼ë¡œ ê³„ì‚°
- "ì±…ì„ì„±"ì´ ì—†ìœ¼ë©´: ì±…ì„ê° ì ìˆ˜ ì‚¬ìš©
- "ë¹„ì „ëª…í™•ì„±"ì´ ì—†ìœ¼ë©´: ë¹„ì „ ì ìˆ˜ ì‚¬ìš©
- ëª¨ë“  ì ìˆ˜ëŠ” 0~100 ë²”ìœ„ì˜ ì •ìˆ˜
- ë°˜ë“œì‹œ ìˆœìˆ˜ JSONë§Œ ë°˜í™˜ (ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡, ì„¤ëª… ì—†ì´)

{
  "name": "í›„ë³´ì ì´ë¦„",
  "party": "ì •ë‹¹ëª…",
  "position": "ì§ì±… ë˜ëŠ” ì§€ì—­êµ¬",
  "total_score": ìˆ«ì(1000ì  ê¸°ì¤€),
  "ai_scores": {"claude": ìˆ«ì, "chatgpt": ìˆ«ì, "gemini": ìˆ«ì, "grok": ìˆ«ì},
  "metrics": {
    "ê³µìµì„±": ìˆ«ì, "ì •ì±…ì‹¤í–‰ë ¥": ìˆ«ì, "ì „ë¬¸ì„±": ìˆ«ì, "ëŒ€ì‘ì„±": ìˆ«ì,
    "ì±…ì„ì„±": ìˆ«ì, "ì†Œí†µëŠ¥ë ¥": ìˆ«ì, "ë¦¬ë”ì‹­": ìˆ«ì, "ë¹„ì „ëª…í™•ì„±": ìˆ«ì,
    "ì²­ë ´ì„±": ìˆ«ì, "ìœ¤ë¦¬ì„±": ìˆ«ì
  },
  "strengths": ["ê°•ì í‚¤ì›Œë“œ1", "ê°•ì í‚¤ì›Œë“œ2", "ê°•ì í‚¤ì›Œë“œ3"],
  "weaknesses": ["ì•½ì í‚¤ì›Œë“œ1", "ì•½ì í‚¤ì›Œë“œ2", "ì•½ì í‚¤ì›Œë“œ3"],
  "summary": "2~3ë¬¸ì¥ ìš”ì•½",
  "education": "í•™ë ¥",
  "career": "ì£¼ìš” ê²½ë ¥ ìš”ì•½"
}

ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸ (ì•ë¶€ë¶„):
${text.substring(0, 9000)}`;

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 2048 }
      })
    }
  );

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || `API ì˜¤ë¥˜ (${res.status})`);
  }

  const result = await res.json();
  const jsonStr = result.candidates[0].content.parts[0].text
    .trim()
    .replace(/^```json?\n?/,'')
    .replace(/\n?```$/,'');
  return JSON.parse(jsonStr);
}

// â”€â”€ ë¡œê·¸ ì¶œë ¥ â”€â”€
function log(msg, type = 'info') {
  const box = document.getElementById('statusLog');
  box.style.display = 'block';
  const line = document.createElement('div');
  line.className = `status-line ${type}`;
  const time = new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  line.textContent = `[${time}] ${msg}`;
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
}

// â”€â”€ ë¶„ì„ ì‹œì‘ â”€â”€
async function startAnalysis() {
  const apiKey = getApiKey();
  if (!apiKey) { alert('API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.'); return; }
  if (selectedFiles.length === 0) { alert('PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.'); return; }

  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
  document.getElementById('statusLog').innerHTML = '';

  const district = document.getElementById('districtName').value.trim() || 'ì„ ê±°êµ¬';
  const electionType = document.getElementById('electionType').value.trim();
  const candidates = [];

  for (let i = 0; i < selectedFiles.length; i++) {
    const f = selectedFiles[i];
    log(`[${i+1}/${selectedFiles.length}] ${f.name} ì²˜ë¦¬ ì‹œì‘...`);
    try {
      log(`  PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...`);
      const text = await extractTextFromPDF(f);
      if (text.length < 100) throw new Error('PDFì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ì…ë ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      log(`  í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ (${text.length}ì)`);

      log(`  Gemini AI ë¶„ì„ ì¤‘...`);
      const candidate = await analyzeWithGemini(text, apiKey);
      candidates.push(candidate);
      log(`  âœ“ ${candidate.name} ë¶„ì„ ì™„ë£Œ (${candidate.total_score}ì )`, 'ok');
    } catch (err) {
      log(`  âœ— ì˜¤ë¥˜: ${err.message}`, 'err');
    }
  }

  if (candidates.length > 0) {
    setData({ candidates, district, election_type: electionType, analysis_date: new Date().toISOString().split('T')[0] });
    log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`, 'info');
    log(`âœ… ë¶„ì„ ì™„ë£Œ! ${candidates.length}ëª… ë°ì´í„° ì €ì¥`, 'ok');
    log(`ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.`, 'ok');
    checkSavedData();
    document.getElementById('saved-data-section').scrollIntoView({ behavior: 'smooth' });
  } else {
    log('ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ ë˜ëŠ” PDFë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'err');
  }

  btn.disabled = false;
  btn.innerHTML = 'ğŸ” ë¶„ì„ ì‹œì‘';
}

// â”€â”€ ìˆ˜ë™ ë°ì´í„° ì…ë ¥ â”€â”€
function loadManualData() {
  const txt = document.getElementById('manualInput').value.trim();
  if (!txt) { alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  try {
    const candidates = JSON.parse(txt);
    if (!Array.isArray(candidates) || candidates.length === 0) throw new Error('ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    const district = document.getElementById('districtName').value.trim() || 'ì„ ê±°êµ¬';
    setData({ candidates, district, analysis_date: new Date().toISOString().split('T')[0] });
    alert(`âœ… ${candidates.length}ëª… ë°ì´í„° ì €ì¥ ì™„ë£Œ!`);
    checkSavedData();
  } catch(e) {
    alert('JSON í˜•ì‹ ì˜¤ë¥˜: ' + e.message);
  }
}

function loadSampleData() {
  const sample = [
    {
      name: "ì •ì›ì˜¤", party: "ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹", position: "ì„œìš¸ ì„±ë™êµ¬ì²­ì¥",
      total_score: 785, education: "í•œì–‘ëŒ€í•™êµ ëŒ€í•™ì› ë„ì‹œê³µí•™ ë°•ì‚¬",
      career: "ì„œìš¸ ì„±ë™êµ¬ì²­ì¥ 3ì„ , ì „êµ­ì‹œì¥êµ°ìˆ˜êµ¬ì²­ì¥í˜‘ì˜íšŒ ê³µë™íšŒì¥",
      ai_scores: { claude: 773, chatgpt: 780, gemini: 812, grok: 771 },
      metrics: { ê³µìµì„±:83, ì •ì±…ì‹¤í–‰ë ¥:82, ì „ë¬¸ì„±:81, ëŒ€ì‘ì„±:82, ì±…ì„ì„±:81, ì†Œí†µëŠ¥ë ¥:81, ë¦¬ë”ì‹­:79, ë¹„ì „ëª…í™•ì„±:76, ì²­ë ´ì„±:73, ìœ¤ë¦¬ì„±:69 },
      strengths: ["ê³µìµì„±","í–‰ì •ì „ë¬¸ì„±","ëŒ€ì‘ë ¥"], weaknesses: ["ìœ¤ë¦¬ì„±","ì²­ë ´ì„±"],
      summary: "3ì„  êµ¬ì²­ì¥ìœ¼ë¡œ í–‰ì • ì „ë¬¸ì„±ê³¼ ê³µìµì  ì„±ê³¼ì—ì„œ ê°•ì ì„ ë³´ì„. í•„ìˆ˜ë…¸ë™ì ë³´í˜¸, ì  íŠ¸ë¦¬í”¼ì¼€ì´ì…˜ ë°©ì§€ ë“± ì„ ë„ì  ì •ì±… ì‹œí–‰."
    },
    {
      name: "ë°•ì£¼ë¯¼", party: "ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹", position: "êµ­íšŒì˜ì› (ì„œìš¸ ì€í‰êµ¬ê°‘)",
      total_score: 753, education: "ì„œìš¸ëŒ€í•™êµ ë²•í•™ê³¼",
      career: "21ëŒ€ êµ­íšŒì˜ì›, ë³€í˜¸ì‚¬ ì¶œì‹  ì¸ê¶Œ í™œë™ê°€",
      ai_scores: { claude: 748, chatgpt: 755, gemini: 760, grok: 749 },
      metrics: { ê³µìµì„±:80, ì •ì±…ì‹¤í–‰ë ¥:76, ì „ë¬¸ì„±:78, ëŒ€ì‘ì„±:77, ì±…ì„ì„±:79, ì†Œí†µëŠ¥ë ¥:82, ë¦¬ë”ì‹­:75, ë¹„ì „ëª…í™•ì„±:74, ì²­ë ´ì„±:76, ìœ¤ë¦¬ì„±:72 },
      strengths: ["ì†Œí†µëŠ¥ë ¥","ê³µìµì„±","ì „ë¬¸ì„±"], weaknesses: ["ë¦¬ë”ì‹­","ë¹„ì „ëª…í™•ì„±"],
      summary: "ì†Œí†µ ëŠ¥ë ¥ê³¼ ê³µìµì„±ì—ì„œ ë†’ì€ í‰ê°€. ì¸ê¶ŒÂ·ë¯¼ìƒ ë¶„ì•¼ ì •ì±… í™œë™ í™œë°œ."
    },
    {
      name: "ì¡°ì€í¬", party: "êµ­ë¯¼ì˜í˜", position: "êµ­íšŒì˜ì› (ì„œìš¸ ì„œì´ˆêµ¬ê°‘)",
      total_score: 745, education: "ì´í™”ì—¬ìëŒ€í•™êµ ê²½ì˜í•™ê³¼",
      career: "20Â·21ëŒ€ êµ­íšŒì˜ì›, ì„œì´ˆêµ¬ì²­ì¥ ì—­ì„",
      ai_scores: { claude: 740, chatgpt: 748, gemini: 752, grok: 740 },
      metrics: { ê³µìµì„±:76, ì •ì±…ì‹¤í–‰ë ¥:75, ì „ë¬¸ì„±:78, ëŒ€ì‘ì„±:76, ì±…ì„ì„±:77, ì†Œí†µëŠ¥ë ¥:75, ë¦¬ë”ì‹­:76, ë¹„ì „ëª…í™•ì„±:73, ì²­ë ´ì„±:78, ìœ¤ë¦¬ì„±:75 },
      strengths: ["ì²­ë ´ì„±","ì „ë¬¸ì„±","ì±…ì„ì„±"], weaknesses: ["ì†Œí†µëŠ¥ë ¥","ë¹„ì „ëª…í™•ì„±"],
      summary: "í–‰ì • ê²½í—˜ê³¼ ì²­ë ´ì„±ì—ì„œ ì•ˆì •ì  í‰ê°€. ê³ ë¥¸ ì ìˆ˜ ë¶„í¬ì˜ ê´€ë¦¬í˜• ë¦¬ë”."
    },
    {
      name: "ì˜¤ì„¸í›ˆ", party: "êµ­ë¯¼ì˜í˜", position: "ì„œìš¸íŠ¹ë³„ì‹œì¥",
      total_score: 732, education: "ì„œìš¸ëŒ€í•™êµ ë²•í•™ê³¼, ë‹¨êµ­ëŒ€ ë²•í•™ ë°•ì‚¬",
      career: "ì„œìš¸ì‹œì¥ 2ì„ , êµ­íšŒì˜ì› 3ì„ ",
      ai_scores: { claude: 740, chatgpt: 730, gemini: 729, grok: 735 },
      metrics: { ê³µìµì„±:78, ì •ì±…ì‹¤í–‰ë ¥:78, ì „ë¬¸ì„±:79, ëŒ€ì‘ì„±:77, ì±…ì„ì„±:80, ì†Œí†µëŠ¥ë ¥:75, ë¦¬ë”ì‹­:82, ë¹„ì „ëª…í™•ì„±:80, ì²­ë ´ì„±:77, ìœ¤ë¦¬ì„±:76 },
      strengths: ["ë¦¬ë”ì‹­","ë¹„ì „ëª…í™•ì„±","ì±…ì„ì„±"], weaknesses: ["ì†Œí†µëŠ¥ë ¥","ê³µìµì„±"],
      summary: "ë¦¬ë”ì‹­ê³¼ ë¹„ì „ ì œì‹œì—ì„œ ê°•ì . ê´‘ì—­ í–‰ì • ê²½í—˜ í’ë¶€í•˜ë‚˜ ì†Œí†µ ì ìˆ˜ ìƒëŒ€ì  ì•½ì„¸."
    }
  ];
  document.getElementById('manualInput').value = JSON.stringify(sample, null, 2);
  document.getElementById('districtName').value = 'ìƒ˜í”Œ ì„ ê±°êµ¬';
}

function clearData() {
  if (!confirm('ì €ì¥ëœ ë¶„ì„ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem('election_data');
  document.getElementById('saved-data-section').style.display = 'none';
  selectedFiles = [];
  renderFileList();
  document.getElementById('statusLog').innerHTML = '';
  document.getElementById('statusLog').style.display = 'none';
}
</script>
</body>
</html>
