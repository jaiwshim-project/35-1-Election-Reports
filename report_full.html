<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ Â· ElectionAI</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* â”€â”€ í™”ë©´ ë ˆì´ì•„ì›ƒ â”€â”€ */
.top-bar {
  position: sticky; top: 0; z-index: 200;
  background: #1e3a8a; color: white;
  padding: 12px 32px; display: flex; align-items: center; gap: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.top-bar h2 { font-size: 15px; font-weight: 700; flex: 1; }
.pdf-btn {
  display: inline-flex; align-items: center; gap: 8px;
  background: #f59e0b; color: #1c1917; border: none; cursor: pointer;
  padding: 9px 22px; border-radius: 8px; font-family: inherit;
  font-size: 14px; font-weight: 800; transition: all 0.2s;
}
.pdf-btn:hover { background: #d97706; transform: translateY(-1px); }
.back-btn {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.15); color: white; border: none; cursor: pointer;
  padding: 7px 14px; border-radius: 6px; font-family: inherit; font-size: 13px;
  text-decoration: none; transition: background 0.2s;
}
.back-btn:hover { background: rgba(255,255,255,0.25); }

.full-report { max-width: 960px; margin: 0 auto; padding: 32px 24px 80px; }

/* â”€â”€ í‘œì§€ â”€â”€ */
.cover-page {
  background: linear-gradient(160deg, #1e3a8a 0%, #1d4ed8 50%, #2563eb 100%);
  color: white; border-radius: 16px; padding: 56px 48px;
  margin-bottom: 32px; position: relative; overflow: hidden;
}
.cover-page::before {
  content: 'âš–ï¸'; font-size: 200px; opacity: 0.05;
  position: absolute; right: -20px; top: -20px; line-height: 1;
}
.cover-badge {
  display: inline-block; background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.3); padding: 4px 14px;
  border-radius: 20px; font-size: 12px; font-weight: 600; margin-bottom: 20px;
}
.cover-page h1 { font-size: 32px; font-weight: 900; line-height: 1.3; margin-bottom: 12px; }
.cover-page .subtitle { font-size: 16px; opacity: .8; margin-bottom: 32px; }
.cover-meta { display: flex; gap: 32px; flex-wrap: wrap; margin-bottom: 32px; }
.cover-meta-item { }
.cover-meta-item .label { font-size: 11px; opacity: .6; text-transform: uppercase; letter-spacing: .8px; margin-bottom: 3px; }
.cover-meta-item .value { font-size: 16px; font-weight: 700; }
.cover-candidates { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 28px; }
.cover-candidate-chip {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 18px; border-radius: 24px; font-size: 14px; font-weight: 700;
}
.cover-candidate-chip .score { opacity: .8; font-size: 12px; margin-left: 6px; }

/* â”€â”€ ì„¹ì…˜ êµ¬ë¶„ â”€â”€ */
.report-section { margin-bottom: 40px; }
.section-header {
  display: flex; align-items: center; gap: 12px;
  background: linear-gradient(90deg, #1e3a8a, #1d4ed8);
  color: white; padding: 14px 20px; border-radius: 10px;
  margin-bottom: 20px; font-size: 18px; font-weight: 800;
}
.section-num {
  background: rgba(255,255,255,0.2); width: 30px; height: 30px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 900; flex-shrink: 0;
}

/* â”€â”€ ìˆœìœ„ ì¹´ë“œ ê·¸ë¦¬ë“œ â”€â”€ */
.rank-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 14px; margin-bottom: 20px; }
.rk-card {
  background: white; border-radius: 12px; padding: 18px 16px;
  border: 2px solid var(--border); box-shadow: var(--shadow);
  position: relative; overflow: hidden;
}
.rk-card .num { font-size: 56px; font-weight: 900; opacity:.05; position:absolute; right:8px; top:0; line-height:1; }
.rk-card .rank-tag-lg {
  width: 32px; height: 32px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:14px; margin-bottom:10px;
}
.rk-card .name { font-size:17px; font-weight:800; }
.rk-card .party { font-size:11px; color:var(--text-muted); margin-bottom:8px; }
.rk-card .big { font-size:34px; font-weight:900; }
.rk-card .prog { height:6px; background:#f1f5f9; border-radius:3px; margin-top:10px; overflow:hidden; }
.rk-card .prog-fill { height:100%; border-radius:3px; }

/* â”€â”€ ì°¨íŠ¸ ê·¸ë¦¬ë“œ â”€â”€ */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.chart-box { background:white; border:1px solid var(--border); border-radius:12px; padding:18px; }
.chart-box h3 { font-size:13px; font-weight:700; color:var(--text-muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:.4px; }

/* â”€â”€ í”„ë¡œíŒŒì¼ ê·¸ë¦¬ë“œ â”€â”€ */
.profile-print-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:16px; }
.pp-card { background:white; border-radius:12px; overflow:hidden; border:1px solid var(--border); }
.pp-head { padding:16px 20px; color:white; }
.pp-head .name { font-size:18px; font-weight:900; margin-bottom:2px; }
.pp-head .sub { font-size:12px; opacity:.85; margin-bottom:8px; }
.pp-head .sc { font-size:30px; font-weight:900; }
.pp-body { padding:16px 20px; }
.pp-info { font-size:12px; color:var(--text-muted); margin-bottom:4px; }
.pp-info strong { color:var(--text); }
.pp-tags { display:flex; flex-wrap:wrap; gap:5px; margin:8px 0; }
.pp-tag { padding:3px 9px; border-radius:12px; font-size:11px; font-weight:600; }
.pp-tag.s { background:#dcfce7; color:#166534; }
.pp-tag.w { background:#fee2e2; color:#991b1b; }
.pp-sum { font-size:12px; color:var(--text-muted); line-height:1.6; margin-top:8px; border-top:1px solid var(--border); padding-top:8px; }
.pp-ai-row { display:grid; grid-template-columns:repeat(4,1fr); gap:4px; margin-top:10px; text-align:center; }
.pp-ai-cell { background:#f8fafc; border-radius:6px; padding:5px 3px; }
.pp-ai-cell .lbl { font-size:9px; font-weight:700; }
.pp-ai-cell .val { font-size:13px; font-weight:800; }

/* â”€â”€ AI ì¼ê´€ì„± â”€â”€ */
.ai-consist-row {
  display:flex; align-items:center; gap:12px;
  background:white; border:1px solid var(--border); border-radius:10px;
  padding:14px 16px; margin-bottom:10px;
}
.ai-consist-name { font-weight:700; width:80px; flex-shrink:0; }
.ai-consist-bars { flex:1; display:flex; gap:6px; }
.ai-consist-bar { flex:1; text-align:center; }
.ai-consist-bar .al { font-size:10px; font-weight:600; }
.ai-consist-bar .av { font-size:14px; font-weight:800; }

/* â”€â”€ ì¸ì‡„ ìŠ¤íƒ€ì¼ â”€â”€ */
@page {
  size: A4;
  margin: 14mm 14mm 22mm 14mm;
  @bottom-right {
    content: counter(page) " / " counter(pages);
    font-size: 9pt;
    color: #94a3b8;
    font-family: 'Noto Sans KR', sans-serif;
  }
}

@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  .top-bar, .app-header, .main-nav { display: none !important; }
  body { background: white !important; margin: 0; }
  .full-report { max-width: 100%; padding: 0; }

  /* í‘œì§€ */
  .cover-page {
    border-radius: 0;
    margin: 0 0 20px;
    padding: 40px 32px;
    background: linear-gradient(160deg, #1e3a8a 0%, #1d4ed8 50%, #2563eb 100%) !important;
    color: white !important;
  }
  .cover-badge {
    background: rgba(255,255,255,0.15) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    color: white !important;
  }
  .cover-candidate-chip {
    background: rgba(255,255,255,0.15) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    color: white !important;
  }

  /* ì„¹ì…˜ í—¤ë” */
  .section-header {
    background: linear-gradient(90deg, #1e3a8a, #1d4ed8) !important;
    color: white !important;
    font-size: 13pt;
  }
  .section-num {
    background: rgba(255,255,255,0.2) !important;
    color: white !important;
  }

  /* ì„¹ì…˜ í˜ì´ì§€ ë¶„ë¦¬ */
  .report-section { page-break-before: always; }
  .report-section:first-child { page-break-before: auto; }

  /* ì¹´ë“œ */
  .card, .rk-card, .pp-card, .chart-box {
    box-shadow: none !important;
    break-inside: avoid;
    border: 1px solid #e2e8f0 !important;
  }

  /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
  .two-col { grid-template-columns: 1fr 1fr; }
  .rank-cards-grid { grid-template-columns: repeat(4, 1fr); }
  .profile-print-grid { grid-template-columns: repeat(2, 1fr); }

  /* ìˆœìœ„ íƒœê·¸ ìƒ‰ìƒ ìœ ì§€ */
  .rank-1 { background: #fef3c7 !important; color: #92400e !important; }
  .rank-2 { background: #f1f5f9 !important; color: #475569 !important; }
  .rank-3 { background: #fef9c3 !important; color: #713f12 !important; }

  /* pp-tag ìƒ‰ìƒ ìœ ì§€ */
  .pp-tag.s { background: #dcfce7 !important; color: #166534 !important; }
  .pp-tag.w { background: #fee2e2 !important; color: #991b1b !important; }

  /* insight-box */
  .insight-box {
    background: #eff6ff !important;
    border: 1px solid #bfdbfe !important;
    color: #1e40af !important;
  }

  /* í‘œ */
  table { font-size: 10pt; }
  h1 { font-size: 22pt; }

  /* ì´ë¯¸ì§€(ì°¨íŠ¸ ë³€í™˜ë³¸) */
  img.chart-img { max-width: 100% !important; height: auto !important; display: block; }
}
</style>
</head>
<body>

<!-- ìƒë‹¨ ë°” -->
<div class="top-bar no-print">
  <a href="report_compare.html" class="back-btn">â† ëŒì•„ê°€ê¸°</a>
  <h2>ğŸ“‹ ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ â€” ëª¨ë“  í•­ëª© í†µí•©</h2>
  <button class="pdf-btn" onclick="savePDF()">ğŸ“¥ PDFë¡œ ì €ì¥</button>
</div>

<div class="full-report" id="fullReport">
  <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
</div>

<!-- ë¦¬í¬íŠ¸ í•˜ë‹¨ í‘¸í„° (í™”ë©´ + PDF ëª¨ë‘ ì¶œë ¥) -->
<div class="full-report">
  <div class="report-print-footer">
    <div class="rpf-inner">
      <div class="rpf-brand">
        <div class="rpf-logo">âš–ï¸ Election<span class="logo-analysis">Analysis</span><span class="logo-report">Report</span><span class="logo-ai">AI</span></div>
        <div class="rpf-tagline">AI ê¸°ë°˜ ì„ ê±° í›„ë³´ì ë¹„êµ ë¶„ì„ í”Œë«í¼ Â· ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ</div>
      </div>
      <div class="rpf-contact">
        <div class="rpf-contact-name">ì‹¬ì¬ìš° ëŒ€í‘œ</div>
        <div class="rpf-contact-items">
          <span>ğŸ“ 010-2397-5734</span>
          <span>âœ‰ï¸ jaiwshim@gmail.com</span>
        </div>
      </div>
    </div>
    <div class="rpf-bottom">
      <span>Â© 2026 ElectionAnalysisReportAI Â· ë¬´ë‹¨ ë³µì œ ë° ë°°í¬ ê¸ˆì§€</span>
      <span>Powered by Claude AI Â· ElectionAI Pricing Engine v1.0</span>
    </div>
  </div>
</div>

<script src="js/shared.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì²´ ë³´ê³ ì„œ ë Œë”ë§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const chartInstances = {};

document.addEventListener('DOMContentLoaded', async () => {
  const data = getData();
  if (!data || !data.candidates?.length) {
    document.getElementById('fullReport').innerHTML = `
      <div class="no-data" style="padding:80px 20px;text-align:center">
        <div style="font-size:56px;margin-bottom:16px">ğŸ“‚</div>
        <h3 style="font-size:22px;color:#64748b">ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p style="color:#94a3b8;margin-bottom:24px">í™ˆì—ì„œ PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
        <a href="index.html" class="btn btn-primary">ğŸ  í™ˆìœ¼ë¡œ ì´ë™</a>
      </div>`;
    return;
  }

  const { candidates, district, analysis_date } = data;
  const n = candidates.length;
  const totalRanks = calcTotalRankings(candidates);
  const sortedC = [...candidates].map((c,i)=>({...c,idx:i})).sort((a,b)=>b.total_score-a.total_score);

  let html = buildCover(candidates, sortedC, district, analysis_date)
    + buildSection1(candidates, sortedC, totalRanks)
    + buildSection2(candidates)
    + buildSection3(candidates, totalRanks)
    + buildSection4(candidates, sortedC)
    + buildSection5(candidates);

  document.getElementById('fullReport').innerHTML = html;

  // ì°¨íŠ¸ ë Œë”ë§ (ìˆœì„œëŒ€ë¡œ)
  renderSection1Charts(candidates);
  renderSection2Charts(candidates);
  renderSection3Charts(candidates);
  renderSection4Charts(candidates, sortedC);
  renderSection5Charts(candidates);
});

/* â”€â”€ í‘œì§€ â”€â”€ */
function buildCover(candidates, sortedC, district, analysis_date) {
  const chips = sortedC.map((c,i) => {
    const col = CANDIDATE_COLORS[c.idx%5];
    return `<div class="cover-candidate-chip" style="border-color:${col.border}cc">
      ${c.name} <span class="score">${c.total_score}ì </span>
    </div>`;
  }).join('');

  return `
  <div class="cover-page">
    <div class="cover-badge">ElectionAI Â· AI ê¸°ë°˜ ì„ ê±° í›„ë³´ì ë¶„ì„ ì‹œìŠ¤í…œ</div>
    <h1>ì„ ê±° í›„ë³´ì<br>ì¢…í•© ë¹„êµ ë¶„ì„ ë³´ê³ ì„œ</h1>
    <div class="subtitle">10ê°œ ì§€í‘œ ê¸°ë°˜ ì •ëŸ‰ í‰ê°€ Â· AI ëª¨ë¸ í†µí•© ë¶„ì„</div>
    <div class="cover-meta">
      <div class="cover-meta-item">
        <div class="label">ì„ ê±°êµ¬</div>
        <div class="value">${district || 'ì„ ê±°êµ¬'}</div>
      </div>
      <div class="cover-meta-item">
        <div class="label">ë¶„ì„ ì¼ì</div>
        <div class="value">${analysis_date || new Date().toISOString().split('T')[0]}</div>
      </div>
      <div class="cover-meta-item">
        <div class="label">ë¶„ì„ í›„ë³´</div>
        <div class="value">${candidates.length}ëª…</div>
      </div>
      <div class="cover-meta-item">
        <div class="label">í‰ê°€ ì§€í‘œ</div>
        <div class="value">10ê°œ í•­ëª©</div>
      </div>
    </div>
    <div style="font-size:12px;opacity:.6;margin-bottom:8px">í›„ë³´ì ì¢…í•© ìˆœìœ„</div>
    <div class="cover-candidates">${chips}</div>
  </div>`;
}

/* â”€â”€ Section 1: ì¢…í•© ë¹„êµ â”€â”€ */
function buildSection1(candidates, sortedC, totalRanks) {
  const n = sortedC.length;
  const rankCards = sortedC.map((c, rank) => {
    const col = CANDIDATE_COLORS[c.idx%5];
    const g = scoreGrade(c.total_score);
    const rankCls = rank===0?'rank-1':rank===1?'rank-2':rank===2?'rank-3':'rank-other';
    return `
    <div class="rk-card" style="border-color:${col.border}">
      <div class="num">${rank+1}</div>
      <div class="rank-tag-lg ${rankCls}">${rank+1}</div>
      <div class="name" style="color:${col.border}">${c.name}</div>
      <div class="party">${c.party}</div>
      <div>
        <span class="big" style="color:${col.border}">${c.total_score}</span>
        <span style="font-size:13px;color:var(--text-muted)">ì </span>
      </div>
      <div style="font-size:11px;color:${col.border};font-weight:600;margin-top:3px">${g.label}ë“±ê¸‰ Â· ${g.desc}</div>
      <div class="prog"><div class="prog-fill" style="width:${(c.total_score/1000)*100}%;background:${col.border}"></div></div>
    </div>`;
  }).join('');

  // í•­ëª©ë³„ ìµœê³  ì ìˆ˜ í…Œì´ë¸”
  let tbl = `<table><thead><tr><th>í‰ê°€ í•­ëª©</th>`;
  sortedC.forEach(c => { tbl += `<th style="color:${CANDIDATE_COLORS[c.idx%5].border}">${c.name}</th>`; });
  tbl += `<th>ìµœê³ </th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map((c,i)=>({name:c.name,score:c.metrics?.[m]??0,col:CANDIDATE_COLORS[i%5]}));
    const max = Math.max(...scores.map(s=>s.score));
    tbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td>`;
    sortedC.forEach(c => {
      const s = c.metrics?.[m]??0;
      tbl += `<td style="${s===max?`background:${CANDIDATE_COLORS[c.idx%5].light};font-weight:700;color:${CANDIDATE_COLORS[c.idx%5].text}`:''}">${s}${s===max?' â˜…':''}</td>`;
    });
    tbl += `<td><strong>${max}</strong></td></tr>`;
  });
  tbl += `</tbody></table>`;

  // ì¸ì‚¬ì´íŠ¸
  const top = sortedC[0], bot = sortedC[n-1];
  const insight = `<strong style="color:${CANDIDATE_COLORS[top.idx%5].border}">${top.name}</strong>ì´(ê°€) ${top.total_score}ì ìœ¼ë¡œ 1ìœ„.
    ${n>1?`2ìœ„ ${sortedC[1].name}(${sortedC[1].total_score}ì )ê³¼ì˜ ê²©ì°¨: <strong>${top.total_score-sortedC[1].total_score}ì </strong>. `:''}
    ${n>2?`ìµœí•˜ìœ„ ${bot.name}(${bot.total_score}ì )ê³¼ì˜ ê²©ì°¨: <strong>${top.total_score-bot.total_score}ì </strong>.`:''}`;

  // â”€â”€ ì¢…í•© ìˆœìœ„ ì¢…í•© ì„¤ëª… â”€â”€
  const avgScore = Math.round(sortedC.reduce((a,c)=>a+c.total_score,0)/n);
  const gap12 = n>1 ? top.total_score - sortedC[1].total_score : 0;
  const spread = n>1 ? top.total_score - bot.total_score : 0;
  const gradeTop = scoreGrade(top.total_score);
  const sum_rank = summaryBox('ì¢…í•© ìˆœìœ„ ë¶„ì„ ì¢…í•© ì„¤ëª…', [
    `ì´ë²ˆ ë¶„ì„ì—ì„œ <strong>${top.name}</strong>(${top.party})ì´(ê°€) ì¢…í•© <strong>${top.total_score}ì </strong>ìœ¼ë¡œ 1ìœ„ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ë“±ê¸‰ì€ <strong>${gradeTop.label}ë“±ê¸‰(${gradeTop.desc})</strong>ìœ¼ë¡œ í‰ê°€ë˜ì—ˆìœ¼ë©°, 4ê°œ AI ëª¨ë¸ â€” Claude, ChatGPT, Gemini, Grok â€” ì˜ í‰ê·  ì ìˆ˜ë¥¼ ì¢…í•©í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì „ì²´ í›„ë³´ì˜ í‰ê·  ì ìˆ˜ëŠ” <strong>${avgScore}ì </strong>ì´ë©°, 1ìœ„ì™€ ìµœí•˜ìœ„ í›„ë³´ ê°„ ì ìˆ˜ ê²©ì°¨ëŠ” <strong>${spread}ì </strong>ì…ë‹ˆë‹¤.`,
    `2ìœ„${n>1?' '+sortedC[1].name:''}ì™€ì˜ ì ìˆ˜ ì°¨ì´ëŠ” <strong>${gap12}ì </strong>ìœ¼ë¡œ, ${gap12 <= 10 ? 'ë§¤ìš° ê²½ìŸì ì¸ êµ¬ë„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì†Œìˆ˜ì  ë‹¨ìœ„ì˜ í‰ê°€ ì°¨ì´ê°€ ìˆœìœ„ë¥¼ ê²°ì •í•˜ëŠ” ë°•ë¹™ì˜ ê²½ìŸì´ í¼ì³ì§€ê³  ìˆì–´, íŠ¹ì • í•­ëª©ì—ì„œì˜ ë‹¨ê¸°ì  ê°œì„ ì´ ì „ì²´ ìˆœìœ„ë¥¼ ë°”ê¿€ ìˆ˜ ìˆëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.' : gap12 <= 30 ? 'ì¼ì •í•œ ì°¨ì´ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ìƒìœ„ê¶Œ ê²½ìŸì€ ì—¬ì „íˆ ì¹˜ì—´í•˜ë©°, 2~3ê°œ í•­ëª©ì˜ ê°œì„ ìœ¼ë¡œ ìˆœìœ„ ë³€ë™ì´ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.' : 'ë¹„êµì  ëšœë ·í•œ ê²©ì°¨ë¥¼ í˜•ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. 1ìœ„ í›„ë³´ê°€ ë‹¤ìˆ˜ í•­ëª©ì—ì„œ ì•ˆì •ì  ìš°ìœ„ë¥¼ í™•ë³´í–ˆìŒì„ ì˜ë¯¸í•˜ë©°, í•˜ìœ„ í›„ë³´ë“¤ì€ ì „ëµì  ì°¨ë³„í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}`,
    `ë³¸ ìˆœìœ„ëŠ” ê³µìµì„±Â·ì „ë¬¸ì„±Â·ì±…ì„ì„±Â·ì²­ë ´ì„± ë“± ìœ ê¶Œìê°€ ì •ì¹˜ì¸ì„ í‰ê°€í•˜ëŠ” í•µì‹¬ 10ê°œ ì—­ëŸ‰ì„ AIê°€ ê³µê°œ ë¬¸ì„œ ë° ë³´ë„ ìë£Œ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì§€ì§€ìœ¨ ì—¬ë¡ ì¡°ì‚¬ì™€ ë‹¬ë¦¬ ê°ì •Â·ì´ë¯¸ì§€ í¸í–¥ ì—†ì´ <strong>ì„±ê³¼ ë° ê³µì•½ ì´í–‰ ë°ì´í„°</strong>ì— ê·¼ê±°í•œ ê°ê´€ì  í‰ê°€ë¼ëŠ” ì ì—ì„œ ì°¨ë³„í™”ë©ë‹ˆë‹¤.`,
    `ì¢…í•© ìˆœìœ„ë§Œìœ¼ë¡œ í›„ë³´ì˜ ì—­ëŸ‰ì„ ë‹¨ì • ì§“ëŠ” ê²ƒì€ í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤. ê° í•­ëª©ë³„ ì ìˆ˜ì™€ ê°•ì Â·ì•½ì  ë¶„í¬ë¥¼ í•¨ê»˜ ë¶„ì„í•˜ë©´ ë³´ë‹¤ ì…ì²´ì ì¸ í›„ë³´ í‰ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. í•˜ë‹¨ì˜ ë ˆì´ë” ì°¨íŠ¸ ë° í•­ëª©ë³„ ìƒì„¸ ë¶„ì„ í˜ì´ì§€ë¥¼ í†µí•´ ê° í›„ë³´ì˜ ì„¸ë¶€ ì—­ëŸ‰ í”„ë¡œíŒŒì¼ì„ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.`
  ]);

  // â”€â”€ ë¹„êµ ì°¨íŠ¸ ì¢…í•© ì„¤ëª… â”€â”€
  const topMetrics = METRICS.map(m=>({m, s:top.metrics?.[m]??0})).sort((a,b)=>b.s-a.s).slice(0,3);
  const sum_chart = summaryBox('ë¹„êµ ì°¨íŠ¸ ì¢…í•© ì„¤ëª…', [
    `ë ˆì´ë” ì°¨íŠ¸ëŠ” 10ê°œ í‰ê°€ í•­ëª©ì— ëŒ€í•œ ê° í›„ë³´ì˜ ì—­ëŸ‰ì„ ë™ì‹œì— ì‹œê°í™”í•©ë‹ˆë‹¤. ì°¨íŠ¸ì—ì„œ ë©´ì ì´ ë„“ê³  ê· í˜• ì¡íŒ ë‹¤ê°í˜•ì„ ê·¸ë¦¬ëŠ” í›„ë³´ì¼ìˆ˜ë¡ ì „ ë¶„ì•¼ì— ê±¸ì³ ê³ ë¥¸ ì—­ëŸ‰ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤. <strong>${top.name}</strong>ì˜ ë ˆì´ë”ëŠ” íŠ¹íˆ <strong>${topMetrics.map(x=>METRIC_LABELS[x.m]).join(', ')}</strong> í•­ëª©ì—ì„œ ì™¸ê³½ìœ¼ë¡œ ë»—ì–´ ìˆì–´ í•´ë‹¹ ì—­ëŸ‰ì´ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤.`,
    `ì¢…í•© ì ìˆ˜ ë§‰ëŒ€ ê·¸ë˜í”„ì—ì„œëŠ” í›„ë³´ ê°„ ì ˆëŒ€ì  ì ìˆ˜ ì°¨ì´ë¥¼ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì „ì²´ í‰ê·  ì ìˆ˜ëŠ” <strong>${avgScore}ì </strong>ì´ë©°, 600ì ~1,000ì  ì²™ë„ ì¤‘ ${avgScore >= 800 ? 'ìƒìœ„ê¶Œ' : avgScore >= 700 ? 'ì¤‘ìƒìœ„ê¶Œ' : 'ì¤‘ìœ„ê¶Œ'}ì— ë¶„í¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ìˆ˜ ë¶„í¬ì˜ ë°€ì§‘ë„ê°€ ë†’ì„ìˆ˜ë¡ í›„ë³´ë“¤ ê°„ì˜ ì‹¤ì§ˆì  ì—­ëŸ‰ ì°¨ì´ê°€ ì‘ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.`,
    `ë‘ ì°¨íŠ¸ë¥¼ í•¨ê»˜ í•´ì„í•  ë•Œ ì¤‘ìš”í•œ ì ì€, ì¢…í•© ì ìˆ˜ê°€ ë†’ë”ë¼ë„ íŠ¹ì • í•­ëª©ì— í¸ì¤‘ëœ í›„ë³´ëŠ” ë ˆì´ë” ì°¨íŠ¸ì—ì„œ ë¹„ëŒ€ì¹­ í˜•íƒœë¥¼ ë³´ì¸ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë°˜ë©´ ì¢…í•© ì ìˆ˜ê°€ ë‹¤ì†Œ ë‚®ì•„ë„ ë ˆì´ë”ê°€ ê· í˜• ì¡íŒ í›„ë³´ëŠ” ì•ˆì •ì ì¸ ì „ë°©ìœ„ ì—­ëŸ‰ì„ ê°–ì¶”ê³  ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    `ìœ ê¶Œì ì…ì¥ì—ì„œëŠ” ë ˆì´ë”ì˜ ë©´ì (ì¢…í•© ì—­ëŸ‰)ê³¼ ê· í˜•ì„±(í•­ëª© ê°„ í¸ì°¨)ì„ í•¨ê»˜ ê³ ë ¤í•´ì•¼ í•˜ë©°, ìì‹ ì´ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” í•­ëª© â€” ì˜ˆì»¨ëŒ€ ì²­ë ´ì„±Â·ê³µìµì„±Â·ì •ì±…ì‹¤í–‰ë ¥ â€” ì—ì„œ ë‘ë“œëŸ¬ì§€ëŠ” í›„ë³´ë¥¼ ë³„ë„ë¡œ í™•ì¸í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•©ë‹ˆë‹¤.`
  ]);

  // â”€â”€ í•­ëª©ë³„ ìµœê³  ì ìˆ˜ ì¢…í•© ì„¤ëª… â”€â”€
  const metricWinCounts = {};
  candidates.forEach((c,i) => { metricWinCounts[i] = 0; });
  METRICS.forEach(m => {
    const sc = candidates.map((c,i)=>({i, s: c.metrics?.[m]??0}));
    const maxS = Math.max(...sc.map(x=>x.s));
    sc.filter(x=>x.s===maxS).forEach(x=>{ metricWinCounts[x.i]++; });
  });
  const topWinEntry = Object.entries(metricWinCounts).sort((a,b)=>b[1]-a[1])[0];
  const topWinnerName = candidates[topWinEntry[0]].name;
  const topWinCount = topWinEntry[1];
  const contestedMetric = METRICS.reduce((best,m) => {
    const sc = candidates.map(c=>c.metrics?.[m]??0);
    const g = Math.max(...sc) - Math.min(...sc);
    return (!best || g < best.gap) ? {m, gap:g} : best;
  }, null);
  const dominantMetric = METRICS.reduce((best,m) => {
    const sc = candidates.map(c=>c.metrics?.[m]??0);
    const g = Math.max(...sc) - Math.min(...sc);
    return (!best || g > best.gap) ? {m, gap:g} : best;
  }, null);
  const sum_metric = summaryBox('í•­ëª©ë³„ ìµœê³  ì ìˆ˜ í›„ë³´ ì¢…í•© ì„¤ëª…', [
    `10ê°œ í‰ê°€ í•­ëª©ë³„ ìµœê³  ì ìˆ˜ ë¶„ì„ì—ì„œ <strong>${topWinnerName}</strong>ì´(ê°€) ì´ <strong>${topWinCount}ê°œ í•­ëª©</strong>ì—ì„œ 1ìœ„ë¥¼ ì°¨ì§€í•˜ë©° ê°€ì¥ ë„“ì€ ì˜ì—­ì—ì„œ ìš°ìœ„ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ëŠ” ë‹¨ìˆœ ì¢…í•© ì ìˆ˜ ìˆœìœ„ì™€ ë”ë¶ˆì–´, í•´ë‹¹ í›„ë³´ì˜ ì—­ëŸ‰ì´ íŠ¹ì • ë¶„ì•¼ì— ì§‘ì¤‘ë˜ì§€ ì•Šê³  ê´‘ë²”ìœ„í•˜ê²Œ ë¶„í¬í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.`,
    `ê°€ì¥ ì¹˜ì—´í•˜ê²Œ ê²½ìŸí•˜ëŠ” í•­ëª©ì€ <strong>${METRIC_LABELS[contestedMetric.m]}</strong>(í›„ë³´ ê°„ ìµœëŒ€ ê²©ì°¨ ${contestedMetric.gap}ì )ìœ¼ë¡œ, ì–´ëŠ í›„ë³´ë„ ì••ë„ì  ìš°ìœ„ë¥¼ ì í•˜ì§€ ëª»í•œ 'ê²©ì „ì§€' í•­ëª©ì…ë‹ˆë‹¤. ë°˜ë©´ <strong>${METRIC_LABELS[dominantMetric.m]}</strong> í•­ëª©ì€ ê²©ì°¨ê°€ ${dominantMetric.gap}ì ìœ¼ë¡œ íŠ¹ì • í›„ë³´ê°€ ë…ë³´ì  ìš°ìœ„ë¥¼ ë³´ì´ëŠ” 'ì°¨ë³„í™” í•­ëª©'ì…ë‹ˆë‹¤.`,
    `í•­ëª©ë³„ ìµœê³  ì ìˆ˜ë¥¼ í™•ë³´í•œ í›„ë³´ ìˆ˜ê°€ ë¶„ì‚°ë˜ì–´ ìˆì„ìˆ˜ë¡ ì„ ê±° ê²½ìŸì˜ ë³µì¡ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤. í•œ í›„ë³´ê°€ ëª¨ë“  í•­ëª©ì„ ì„ê¶Œí•  ë•Œì™€ ì—¬ëŸ¬ í›„ë³´ê°€ ì„œë¡œ ë‹¤ë¥¸ í•­ëª©ì—ì„œ 1ìœ„ë¥¼ ë‚˜ëˆ  ê°€ì§ˆ ë•ŒëŠ” ìœ ê¶Œìì˜ ì„ íƒ ê¸°ì¤€ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì „ìëŠ” ëª…í™•í•œ ë¦¬ë”ê°€ ìˆëŠ” êµ¬ì¡°ì´ê³ , í›„ìëŠ” ìœ ê¶Œì ê°œì¸ì˜ ê°€ì¹˜ê´€ì´ íˆ¬í‘œ ê²°ê³¼ë¥¼ ê²°ì •í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.`,
    `ì´ ë¶„ì„ì€ ê° í›„ë³´ì˜ 'í•µì‹¬ ê°•ì  í•­ëª©'ì„ íŒŒì•…í•˜ê³  ì„ ê±° ì „ëµì„ ìˆ˜ë¦½í•˜ëŠ” ë° ì§ì ‘ì ìœ¼ë¡œ í™œìš©ë©ë‹ˆë‹¤. ìœ ê¶Œì ì…ì¥ì—ì„œëŠ” ìì‹ ì´ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” í•­ëª©ì—ì„œ 1ìœ„ë¥¼ ì°¨ì§€í•œ í›„ë³´ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ í›„ë³´ ì„ íƒì˜ ê·¼ê±°ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  ]);

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">1</div>ğŸ“Š ì¢…í•© ë¹„êµ ë¶„ì„</div>
    <div class="card"><div class="card-title">ğŸ† ì¢…í•© ìˆœìœ„</div>
      <div class="rank-cards-grid">${rankCards}</div>
    </div>
    ${sum_rank}
    <div class="two-col">
      <div class="chart-box"><h3>ğŸ•¸ï¸ 10ê°œ í•­ëª© ë ˆì´ë” ë¹„êµ</h3>
        <div style="height:300px"><canvas id="s1_radar"></canvas></div>
      </div>
      <div class="chart-box"><h3>ğŸ“Š ì¢…í•© ì ìˆ˜ ë§‰ëŒ€</h3>
        <div style="height:300px"><canvas id="s1_bar"></canvas></div>
      </div>
    </div>
    ${sum_chart}
    <div class="card"><div class="card-title">ğŸ¯ í•­ëª©ë³„ ìµœê³  ì ìˆ˜ í›„ë³´</div>
      <div class="table-wrap">${tbl}</div>
    </div>
    ${sum_metric}
    <div class="insight-box">${insight}</div>
  </div>`;
}

/* â”€â”€ Section 2: ì ìˆ˜ ìƒì„¸ â”€â”€ */
function buildSection2(candidates) {
  const n = candidates.length;

  // íˆíŠ¸ë§µ í…Œì´ë¸”
  let tbl = `<table><thead><tr><th>í•­ëª©</th>`;
  candidates.forEach((c,i) => { tbl += `<th style="color:${CANDIDATE_COLORS[i%5].border}">${c.name}</th>`; });
  tbl += `<th>í‰ê· </th><th>ìµœê³ </th><th>ìµœì €</th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map(c=>c.metrics?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/n;
    const max = Math.max(...scores), min = Math.min(...scores);
    tbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td>`;
    scores.forEach((s,i) => {
      const isMax=s===max, isMin=s===min, col=CANDIDATE_COLORS[i%5];
      tbl += `<td style="${isMax?`background:${col.light};font-weight:800;color:${col.text}`:isMin?'background:#fff7ed;color:#92400e;font-weight:700':''}">${s}${isMax?'â–²':isMin?'â–¼':''}</td>`;
    });
    tbl += `<td>${avg.toFixed(1)}</td><td style="color:var(--success);font-weight:700">${max}</td><td style="color:var(--danger);font-weight:700">${min}</td></tr>`;
  });
  tbl += `</tbody></table>`;

  // â”€â”€ íˆíŠ¸ë§µ ì¢…í•© ì„¤ëª… â”€â”€
  const allAvgByMetric = METRICS.map(m => {
    const scores = candidates.map(c=>c.metrics?.[m]??0);
    return { m, avg: scores.reduce((a,b)=>a+b,0)/n, max: Math.max(...scores), min: Math.min(...scores) };
  });
  const highestMetric = allAvgByMetric.reduce((a,b)=>b.avg>a.avg?b:a);
  const lowestMetric = allAvgByMetric.reduce((a,b)=>b.avg<a.avg?b:a);
  const uniformHigh = candidates.filter(c => METRICS.every(m=>(c.metrics?.[m]??0)>=75)).map(c=>c.name);
  const sum_heatmap = summaryBox('ì ìˆ˜ íˆíŠ¸ë§µ ì¢…í•© ì„¤ëª…', [
    `ì ìˆ˜ íˆíŠ¸ë§µì€ 10ê°œ í‰ê°€ í•­ëª©ê³¼ ê° í›„ë³´ì˜ ì ìˆ˜ë¥¼ êµì°¨ ì‹œê°í™”í•˜ì—¬ ê°•ì ê³¼ ì•½ì  íŒ¨í„´ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ê°•ì¡° ìƒ‰ìƒ(â–²)ì´ ì§‘ì¤‘ëœ ì—´ì˜ í›„ë³´ëŠ” í•´ë‹¹ í•­ëª©êµ°ì—ì„œ ì§€ì†ì  ê°•ì ì„ ë³´ì´ë©°, ë°˜ëŒ€ë¡œ â–¼ í‘œì‹œê°€ ë§ì€ í›„ë³´ëŠ” ê·¸ í•­ëª©ë“¤ì—ì„œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
    `í•­ëª©ë³„ í‰ê·  ì ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ <strong>${METRIC_LABELS[highestMetric.m]}</strong> í•­ëª©ì´ í‰ê·  <strong>${highestMetric.avg.toFixed(1)}ì </strong>ìœ¼ë¡œ í›„ë³´ ì „ì²´ì—ì„œ ê°€ì¥ ë†’ì€ ì ìˆ˜ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ë°˜ë©´ <strong>${METRIC_LABELS[lowestMetric.m]}</strong> í•­ëª©ì€ í‰ê·  <strong>${lowestMetric.avg.toFixed(1)}ì </strong>ìœ¼ë¡œ ê°€ì¥ ë‚®ì•„, í›„ë³´ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ë³´ì™„ì´ í•„ìš”í•œ ì˜ì—­ì„ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.`,
    `${uniformHigh.length > 0 ? `<strong>${uniformHigh.join(', ')}</strong>ì€(ëŠ”) ì „ í•­ëª©ì—ì„œ 75ì  ì´ìƒì„ ìœ ì§€í•˜ë©° ê· í˜• ì¡íŒ ì—­ëŸ‰ì„ ë³´ì—¬ì¤¬ìŠµë‹ˆë‹¤. ì´ì²˜ëŸ¼ íˆíŠ¸ë§µì—ì„œ ì „ë°˜ì ìœ¼ë¡œ ë°ì€ ìƒ‰ì¡°ë¥¼ ë³´ì´ëŠ” í›„ë³´ëŠ” íŠ¹ì • ì´ìŠˆ ê³µì„¸ì—ë„ ì•ˆì •ì ìœ¼ë¡œ ëŒ€ì‘í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ì  ê°•ì ì„ ì§€ë‹™ë‹ˆë‹¤.` : `íŠ¹ì • í•­ëª©ì—ì„œ ìƒ‰ìƒ ëŒ€ë¹„ê°€ ëšœë ·ì´ ë‚˜íƒ€ë‚˜ëŠ” í›„ë³´ëŠ” ê°•ì  í•­ëª©ì„ ì „ëµì ìœ¼ë¡œ ë¶€ê°í•˜ë©´ì„œ ì•½ì  í•­ëª©ì€ ì ê·¹ì ìœ¼ë¡œ ë³´ì™„í•˜ëŠ” ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.`}`,
    `íˆíŠ¸ë§µì„ ë¶„ì„í•  ë•ŒëŠ” ë‹¨ìˆœíˆ ë†’ì€ ì ìˆ˜ì—ë§Œ ì§‘ì¤‘í•˜ê¸°ë³´ë‹¤, ê²½ìŸ í›„ë³´ ëŒ€ë¹„ ìƒëŒ€ì ìœ¼ë¡œ ë†’ì€ í•­ëª©(ìì‹ ì˜ ì°¨ë³„í™” í¬ì¸íŠ¸)ê³¼ ë‚®ì€ í•­ëª©(ìƒëŒ€ê°€ ê³µì„¸í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì )ì„ ë™ì‹œì— íŒŒì•…í•˜ëŠ” ê²ƒì´ ì „ëµì ìœ¼ë¡œ ì¤‘ìš”í•©ë‹ˆë‹¤. íŠ¹íˆ ì²­ë ´ì„±Â·ìœ¤ë¦¬ì„± í•­ëª©ì˜ ì ìˆ˜ ë¶„í¬ëŠ” ìœ ê¶Œì ì‹ ë¢°ë„ì™€ ì§ê²°ë©ë‹ˆë‹¤.`
  ]);

  // í‘œì¤€í¸ì°¨ í…Œì´ë¸”
  let stdTbl = `<table><thead><tr><th>í›„ë³´ì</th>`;
  METRICS.forEach(m => { stdTbl += `<th>${METRIC_LABELS[m].replace(' ','<br>')}</th>`; });
  stdTbl += `<th>í‘œì¤€í¸ì°¨</th><th>ê· í˜•ì„±</th></tr></thead><tbody>`;
  candidates.forEach((c,i) => {
    const scores = METRICS.map(m=>c.metrics?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const col = CANDIDATE_COLORS[i%5];
    stdTbl += `<tr><td style="color:${col.border};font-weight:700">${c.name}</td>`;
    scores.forEach(s => { stdTbl += `<td>${s}</td>`; });
    stdTbl += `<td><strong>${std.toFixed(1)}</strong></td><td>${std<5?'ğŸŸ¢ ê· í˜•':std<8?'ğŸŸ¡ ë³´í†µ':'ğŸ”´ í¸ì¤‘'}</td></tr>`;
  });
  stdTbl += `</tbody></table>`;

  // â”€â”€ ê· í˜•ì„± ë¶„ì„ ì¢…í•© ì„¤ëª… â”€â”€
  const stdData = candidates.map((c,i) => {
    const scores = METRICS.map(m=>c.metrics?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    return { name: c.name, party: c.party, std, avg };
  });
  const mostBalanced = stdData.reduce((a,b)=>b.std<a.std?b:a);
  const leastBalanced = stdData.reduce((a,b)=>b.std>a.std?b:a);
  const avgStd = stdData.reduce((a,b)=>a+b.std,0)/stdData.length;
  const sum_balance = summaryBox('ê· í˜•ì„± ë¶„ì„(í‘œì¤€í¸ì°¨) ì¢…í•© ì„¤ëª…', [
    `ê· í˜•ì„± ë¶„ì„ì€ ê° í›„ë³´ê°€ 10ê°œ í‰ê°€ í•­ëª©ì—ì„œ ì–¼ë§ˆë‚˜ ê³ ë¥¸ ì—­ëŸ‰ì„ ë³´ì´ëŠ”ì§€ë¥¼ í‘œì¤€í¸ì°¨ë¡œ ì¸¡ì •í•©ë‹ˆë‹¤. í‘œì¤€í¸ì°¨ê°€ <strong>5 ë¯¸ë§Œì´ë©´ ê· í˜•</strong>, 5~8ì´ë©´ ë³´í†µ, 8 ì´ìƒì´ë©´ íŠ¹ì • í•­ëª©ì— í¸ì¤‘ëœ ë¶ˆê· í˜• ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì „ì²´ í›„ë³´ì˜ í‰ê·  í‘œì¤€í¸ì°¨ëŠ” <strong>${avgStd.toFixed(1)}</strong>ì…ë‹ˆë‹¤.`,
    `<strong>${mostBalanced.name}</strong>ì€(ëŠ”) í‘œì¤€í¸ì°¨ <strong>${mostBalanced.std.toFixed(1)}</strong>ë¡œ ê°€ì¥ ê· í˜• ì¡íŒ ì—­ëŸ‰ ë¶„í¬ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ëŠ” ì–´ëŠ í•œ í•­ëª©ì—ë„ ì¹˜ìš°ì¹˜ì§€ ì•Šê³  ì „ ë¶„ì•¼ì—ì„œ ì•ˆì •ì ì¸ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ê³  ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ê· í˜•ì„±ì´ ë†’ì€ í›„ë³´ëŠ” ìƒëŒ€ í›„ë³´ì˜ íŠ¹ì • í•­ëª© ê³µì„¸ì—ë„ ë¹„êµì  ë°©ì–´ê°€ ìš©ì´í•©ë‹ˆë‹¤.`,
    `ë°˜ë©´ <strong>${leastBalanced.name}</strong>ì€(ëŠ”) í‘œì¤€í¸ì°¨ <strong>${leastBalanced.std.toFixed(1)}</strong>ë¡œ í•­ëª© ê°„ í¸ì°¨ê°€ ìƒëŒ€ì ìœ¼ë¡œ ì»¸ìŠµë‹ˆë‹¤. ì´ ê²½ìš° ê°•ì  í•­ëª©ì—ì„œëŠ” ë…ë³´ì ì¸ ìš°ìœ„ë¥¼ ë³´ì´ì§€ë§Œ, ì•½ì  í•­ëª©ì´ ë…¸ì¶œë  ê²½ìš° ìƒëŒ€ í›„ë³´ì˜ ê³µì„¸ì— ì·¨ì•½í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì„ ê±° ìº í”„ ì…ì¥ì—ì„œëŠ” ì•½ì  í•­ëª©ì˜ ì§‘ì¤‘ ê°œì„  ë˜ëŠ” ê°•ì  í•­ëª© ê·¹ëŒ€í™” ì „ëµ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.`,
    `ê· í˜•ì„±ê³¼ ì¢…í•© ì ìˆ˜ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì°¨ì›ì˜ ì§€í‘œì…ë‹ˆë‹¤. ì ìˆ˜ê°€ ë‹¤ì†Œ ë‚®ë”ë¼ë„ ê· í˜•ì„±ì´ ë†’ì€ í›„ë³´ëŠ” ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë¦¬ë”ì‹­ì„ ë³´ì—¬ì£¼ë©°, ì´ëŠ” ì¤‘ë„ì¸µ ìœ ê¶Œìì—ê²Œ íŠ¹íˆ ê¸ì •ì ìœ¼ë¡œ ì‘ìš©í•©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ í¸ì¤‘ëœ í›„ë³´ëŠ” íŠ¹ì • ì§€ì§€ì¸µì—ê²Œ ê°•ë ¥í•œ í˜¸ì†Œë ¥ì„ ë°œíœ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  ]);

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">2</div>ğŸ“ˆ 10ê°œ í•­ëª© ì ìˆ˜ ìƒì„¸</div>
    <div class="card"><div class="card-title">ğŸ”¥ ì ìˆ˜ íˆíŠ¸ë§µ</div>
      <div class="table-wrap">${tbl}</div>
      <div class="insight-box" style="margin-top:10px">â–² í•´ë‹¹ í•­ëª© ìµœê³   |  â–¼ í•´ë‹¹ í•­ëª© ìµœì €</div>
    </div>
    ${sum_heatmap}
    <div class="card"><div class="card-title">ğŸ“Š í•­ëª©ë³„ ê·¸ë£¹ ë¹„êµ</div>
      <div style="height:360px"><canvas id="s2_grouped"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“ ê· í˜•ì„± ë¶„ì„ (í‘œì¤€í¸ì°¨)</div>
      <div class="table-wrap">${stdTbl}</div>
    </div>
    ${sum_balance}
  </div>`;
}

/* â”€â”€ Section 3: í›„ë³´ì í”„ë¡œíŒŒì¼ â”€â”€ */
function buildSection3(candidates, totalRanks) {
  const cards = candidates.map((c, i) => {
    const col = CANDIDATE_COLORS[i%5];
    const rank = totalRanks[i];
    const g = scoreGrade(c.total_score);
    const topM = METRICS.map(m=>({m,s:c.metrics?.[m]??0})).sort((a,b)=>b.s-a.s).slice(0,3);
    const botM = METRICS.map(m=>({m,s:c.metrics?.[m]??0})).sort((a,b)=>a.s-b.s).slice(0,3);
    const aiRow = AI_MODELS.map(m => `
      <div class="pp-ai-cell">
        <div class="lbl" style="color:${col.border}">${AI_LABELS[m]}</div>
        <div class="val" style="color:${col.border}">${c.ai_scores?.[m]??'-'}</div>
      </div>`).join('');

    return `
    <div class="pp-card">
      <div class="pp-head" style="background:linear-gradient(135deg,${col.border}ee,${col.border})">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">${c.name}</div>
            <div class="sub">${c.party} Â· ${c.position||''}</div>
            <div class="sc">${c.total_score}ì  <span style="font-size:13px;opacity:.8">${g.label}ë“±ê¸‰</span></div>
          </div>
          <div style="background:rgba(255,255,255,0.2);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px">${rank}</div>
        </div>
      </div>
      <div class="pp-body">
        ${c.education?`<div class="pp-info"><strong>í•™ë ¥</strong> ${c.education}</div>`:''}
        ${c.career?`<div class="pp-info"><strong>ê²½ë ¥</strong> ${c.career}</div>`:''}
        <div style="height:180px;margin:12px 0"><canvas id="s3_radar_${i}"></canvas></div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">ê°•ì  í•­ëª©</div>
        <div class="pp-tags">${topM.map(x=>`<span class="pp-tag s">${METRIC_LABELS[x.m]} ${x.s}</span>`).join('')}${(c.strengths||[]).map(s=>`<span class="pp-tag s">${s}</span>`).join('')}</div>
        <div style="font-size:11px;color:var(--text-muted);margin:6px 0">ê°œì„  í•­ëª©</div>
        <div class="pp-tags">${botM.map(x=>`<span class="pp-tag w">${METRIC_LABELS[x.m]} ${x.s}</span>`).join('')}${(c.weaknesses||[]).map(s=>`<span class="pp-tag w">${s}</span>`).join('')}</div>
        ${c.summary?`<div class="pp-sum">${c.summary}</div>`:''}
        <div class="pp-ai-row">${aiRow}</div>
      </div>
    </div>`;
  }).join('');

  // â”€â”€ í”„ë¡œíŒŒì¼ ì¹´ë“œ ì¢…í•© ì„¤ëª… â”€â”€
  const totalRanksArr = [...candidates].map((c,i)=>({...c,i})).sort((a,b)=>b.total_score-a.total_score);
  const topC = totalRanksArr[0];
  const topCMetrics = METRICS.map(m=>({m,s:topC.metrics?.[m]??0})).sort((a,b)=>b.s-a.s).slice(0,3);
  const avgAll = Math.round(candidates.reduce((a,c)=>a+c.total_score,0)/candidates.length);
  const aboveAvg = candidates.filter(c=>c.total_score>=avgAll).map(c=>c.name);
  const sum_profiles = summaryBox('í›„ë³´ì í”„ë¡œíŒŒì¼ ì¢…í•© ì„¤ëª…', [
    `ê° í›„ë³´ì í”„ë¡œíŒŒì¼ ì¹´ë“œëŠ” ì¢…í•© ì ìˆ˜, AI ëª¨ë¸ë³„ ì ìˆ˜, 10ê°œ í•­ëª© ë ˆì´ë” ì°¨íŠ¸, ê°•ì Â·ì•½ì  í‚¤ì›Œë“œë¥¼ í†µí•©ì ìœ¼ë¡œ ì œì‹œí•©ë‹ˆë‹¤. <strong>${topC.name}</strong>(${topC.party})ì´(ê°€) <strong>${topC.total_score}ì </strong>ìœ¼ë¡œ 1ìœ„ë¥¼ ê¸°ë¡í–ˆìœ¼ë©°, íŠ¹íˆ <strong>${topCMetrics.map(x=>METRIC_LABELS[x.m]).join(', ')}</strong> í•­ëª©ì—ì„œ ë‘ë“œëŸ¬ì§„ ì—­ëŸ‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.`,
    `ì „ì²´ í›„ë³´ í‰ê·  ì ìˆ˜ì¸ <strong>${avgAll}ì </strong> ì´ìƒì„ ê¸°ë¡í•œ í›„ë³´ëŠ” <strong>${aboveAvg.join(', ')}</strong>ì…ë‹ˆë‹¤. ê° í›„ë³´ì˜ ë¯¸ë‹ˆ ë ˆì´ë” ì°¨íŠ¸ì—ì„œëŠ” ê°œì¸ë³„ë¡œ ê°•ì¡°ë˜ëŠ” ì—­ëŸ‰ê³¼ ê°œì„ ì´ í•„ìš”í•œ ì˜ì—­ì´ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„ë˜ì–´, í›„ë³´ì ê°„ ì—­ëŸ‰ êµ¬ì¡°ì˜ ì°¨ì´ë¥¼ ì§ê´€ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    `AI ëª¨ë¸ 4ê°œ(Claude, ChatGPT, Gemini, Grok)ê°€ ê°ê° ë¶€ì—¬í•œ ì ìˆ˜ë¥¼ ì¹´ë“œ í•˜ë‹¨ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë¸ ê°„ ì ìˆ˜ ì°¨ì´ê°€ í° í›„ë³´ëŠ” í‰ê°€ ê¸°ì¤€ì— ë”°ë¼ íŒë‹¨ì´ ê°ˆë¦¬ëŠ” 'ë…¼ìŸì  í”„ë¡œíŒŒì¼'ì„ ê°€ì§€ë©°, ì ìˆ˜ ì°¨ì´ê°€ ì‘ì€ í›„ë³´ëŠ” AI ëª¨ë¸ ì „ì²´ì— ê±¸ì³ ì¼ê´€ì ìœ¼ë¡œ í‰ê°€ë˜ëŠ” 'ì•ˆì •ì  í”„ë¡œíŒŒì¼'ì„ ë³´ì…ë‹ˆë‹¤.`,
    `ê°•ì Â·ì•½ì  íƒœê·¸ëŠ” í•´ë‹¹ í›„ë³´ì˜ ê³µê°œëœ í™œë™ ê¸°ë¡ê³¼ AI ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ ë„ì¶œëœ ê²ƒì…ë‹ˆë‹¤. ê°•ì  í•­ëª©ì€ ìœ ê¶Œì ì†Œí†µì—ì„œ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë©”ì‹œì§€ ìì›ì´ ë˜ë©°, ì•½ì  í•­ëª©ì€ ìƒëŒ€ í›„ë³´ì˜ ê³µì„¸ ëŒ€ìƒì´ ë  ìˆ˜ ìˆì–´ ì‚¬ì „ ëŒ€ì‘ ì „ëµ ìˆ˜ë¦½ì´ í•„ìš”í•©ë‹ˆë‹¤.`
  ]);

  // êµì°¨ë¶„ì„ í…Œì´ë¸”
  let crossTbl = `<table><thead><tr><th>í•­ëª©</th>`;
  candidates.forEach((c,i) => { crossTbl += `<th style="color:${CANDIDATE_COLORS[i%5].border}">${c.name}</th>`; });
  crossTbl += `<th>í•­ëª© í‰ê· </th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map(c => c.metrics?.[m] ?? 0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const max = Math.max(...scores);
    crossTbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td>`;
    scores.forEach((s,i) => {
      const col = CANDIDATE_COLORS[i%5];
      const isMax = s === max;
      crossTbl += `<td style="${isMax?`color:${col.border};font-weight:800`:''}">${s}${isMax?' ğŸ†':''}</td>`;
    });
    crossTbl += `<td style="color:var(--text-muted)">${avg.toFixed(1)}</td></tr>`;
  });
  crossTbl += `</tbody></table>`;

  // â”€â”€ êµì°¨ë¶„ì„ ì¢…í•© ì„¤ëª… â”€â”€
  const metricLeaders = METRICS.map(m => {
    const scores = candidates.map((c,i)=>({name:c.name,s:c.metrics?.[m]??0,i}));
    const maxS = Math.max(...scores.map(x=>x.s));
    return { m, leader: scores.find(x=>x.s===maxS), max:maxS, min: Math.min(...scores.map(x=>x.s)), gap: maxS - Math.min(...scores.map(x=>x.s)) };
  });
  const topCompetitive = [...metricLeaders].sort((a,b)=>a.gap-b.gap).slice(0,2);
  const topDominant = [...metricLeaders].sort((a,b)=>b.gap-a.gap).slice(0,2);
  const uniqueLeaders = [...new Set(metricLeaders.map(x=>x.leader.name))];
  const sum_cross = summaryBox('10ê°œ í•­ëª© ê°œì¸ë³„ êµì°¨ë¶„ì„ ì¢…í•© ì„¤ëª…', [
    `10ê°œ í•­ëª© ê°œì¸ë³„ êµì°¨ë¶„ì„í‘œëŠ” ê° í›„ë³´ì˜ í•­ëª©ë³„ ì ìˆ˜ë¥¼ ë‚˜ë€íˆ ë°°ì¹˜í•˜ì—¬, ì–´ëŠ í•­ëª©ì—ì„œ ëˆ„ê°€ ì•ì„œê³  ë’¤ì²˜ì§€ëŠ”ì§€ë¥¼ ì§ì ‘ ë¹„êµí•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. í•­ëª©ë³„ 1ìœ„ë¥¼ ì°¨ì§€í•˜ëŠ” í›„ë³´ê°€ ë¶„ì‚°ë˜ì–´ ìˆì„ìˆ˜ë¡ ì„ ê±° ê²½ìŸ êµ¬ë„ê°€ ë‹¤ì›í™”ë©ë‹ˆë‹¤. ì´ë²ˆ ë¶„ì„ì—ì„œëŠ” <strong>${uniqueLeaders.join(', ')}</strong>ì´(ê°€) í•­ëª©ë³„ 1ìœ„ë¥¼ ë‚˜ëˆ  ê°€ì¡ŒìŠµë‹ˆë‹¤.`,
    `í•­ëª© ê°„ ê²½ìŸì´ ê°€ì¥ ì¹˜ì—´í•œ êµ¬ê°„ì€ <strong>${topCompetitive.map(x=>METRIC_LABELS[x.m]).join(', ')}</strong>ìœ¼ë¡œ, í›„ë³´ ê°„ ì ìˆ˜ ì°¨ì´ê°€ ${topCompetitive.map(x=>x.gap+'ì ').join(', ')}ì— ë¶ˆê³¼í•©ë‹ˆë‹¤. ì´ í•­ëª©ë“¤ì€ ì„ ê±° ê²°ê³¼ì— ê²°ì •ì  ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆëŠ” 'ìŠ¹ë¶€ì²˜'ë¡œ, í•´ë‹¹ í•­ëª©ì—ì„œì˜ ì¸ìƒì ì¸ ê³µì•½ ì´í–‰ ë˜ëŠ” ì´ë¯¸ì§€ ê°œì„ ì´ ì „ì²´ ìˆœìœ„ë¥¼ ë’¤í”ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    `ë°˜ëŒ€ë¡œ <strong>${topDominant.map(x=>METRIC_LABELS[x.m]).join(', ')}</strong> í•­ëª©ì—ì„œëŠ” í›„ë³´ ê°„ ê²©ì°¨ê°€ ${topDominant.map(x=>x.gap+'ì ').join(', ')}ìœ¼ë¡œ íŠ¹ì • í›„ë³´ì˜ ìš°ìœ„ê°€ ëšœë ·í•©ë‹ˆë‹¤. ì´ í•­ëª©ë“¤ì€ ë¦¬ë” í›„ë³´ì˜ í•µì‹¬ ì°¨ë³„í™” ìì‚°ì´ ë˜ë©°, ë‚˜ë¨¸ì§€ í›„ë³´ë“¤ì—ê²ŒëŠ” ì¥ê¸°ì  ì—­ì „ì„ ìœ„í•´ ì§‘ì¤‘ ê³µëµì´ í•„ìš”í•œ ì˜ì—­ì…ë‹ˆë‹¤.`,
    `í•­ëª© í‰ê· ê°’ê³¼ ê°œì¸ ì ìˆ˜ë¥¼ ëŒ€ì¡°í•˜ë©´ ì „ì²´ ìˆ˜ì¤€ ëŒ€ë¹„ ê° í›„ë³´ì˜ ìƒëŒ€ì  ìœ„ì¹˜ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•­ëª© í‰ê·  ì´ìƒì„ ì§€ì†ì ìœ¼ë¡œ ìœ ì§€í•˜ëŠ” í›„ë³´ëŠ” ì „ëµì  ì•ˆì •ì„±ì´ ë†’ê³ , íŠ¹ì • í•­ëª©ì—ì„œë§Œ í‰ê· ì„ ìƒíšŒí•˜ëŠ” í›„ë³´ëŠ” í•´ë‹¹ ì—­ëŸ‰ì„ ì§‘ì¤‘ í™ë³´í•˜ëŠ” 'ì„ íƒê³¼ ì§‘ì¤‘' ì „ëµì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.`
  ]);

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">3</div>ğŸ‘¤ í›„ë³´ì í”„ë¡œíŒŒì¼</div>
    <div class="profile-print-grid">${cards}</div>
    ${sum_profiles}
    <div class="card" style="margin-top:20px">
      <div class="card-title">ğŸ“Š 10ê°œ í•­ëª© ê°œì¸ë³„ ë¹„êµ ë¶„ì„</div>
      <div class="table-wrap">${crossTbl}</div>
    </div>
    ${sum_cross}
  </div>`;
}

/* â”€â”€ Section 4: ê²©ì°¨ ë¶„ì„ â”€â”€ */
function buildSection4(candidates, sortedC) {
  const leader = sortedC[0];
  const n = candidates.length;

  // ì¢…í•© ê²©ì°¨ í…Œì´ë¸”
  let sumTbl = `<table><thead><tr><th>ìˆœìœ„</th><th>í›„ë³´ì</th><th>ì¢…í•© ì ìˆ˜</th><th>1ìœ„ ëŒ€ë¹„ ê²©ì°¨</th><th>ë¹„ìœ¨</th></tr></thead><tbody>`;
  sortedC.forEach((c, rank) => {
    const gap = c.total_score - leader.total_score;
    const pct = ((c.total_score/leader.total_score)*100).toFixed(1);
    const col = CANDIDATE_COLORS[c.idx%5];
    sumTbl += `<tr>
      <td>${rankTag(rank+1)}</td>
      <td style="color:${col.border};font-weight:700">${c.name}</td>
      <td style="font-weight:800;font-size:14px">${c.total_score}ì </td>
      <td style="font-weight:700;color:${gap===0?'var(--text-muted)':'var(--warning)'}">${gap===0?'ê¸°ì¤€':(gap>0?'+':'')+gap+'ì '}</td>
      <td>${pct}%</td>
    </tr>`;
  });
  sumTbl += `</tbody></table>`;

  // í•­ëª©ë³„ ê²©ì°¨ í…Œì´ë¸”
  let metTbl = `<table><thead><tr><th>í•­ëª©</th><th>${leader.name}<br>(ê¸°ì¤€)</th>`;
  sortedC.slice(1).forEach(c => { metTbl += `<th style="color:${CANDIDATE_COLORS[c.idx%5].border}">${c.name}<br>ê²©ì°¨</th>`; });
  metTbl += `<th>ìµœëŒ€ê²©ì°¨</th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const ls = leader.metrics?.[m]??0;
    const gaps = sortedC.slice(1).map(c=>(c.metrics?.[m]??0)-ls);
    const maxG = Math.max(...gaps.map(g=>Math.abs(g)));
    metTbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td><td style="font-weight:700">${ls}</td>`;
    gaps.forEach((g,ii)=>{
      const col = CANDIDATE_COLORS[sortedC[ii+1].idx%5];
      metTbl += `<td style="color:${g>0?'var(--success)':g<0?'var(--warning)':'var(--text-muted)'};font-weight:700">${g>0?'+'+g:g}</td>`;
    });
    metTbl += `<td style="font-weight:700">${maxG}ì </td></tr>`;
  });
  metTbl += `</tbody></table>`;

  // ê²½ìŸ ìš°ìœ„ í…Œì´ë¸”
  let compTbl = `<table><thead><tr><th>í•­ëª©</th><th>1ìœ„ í›„ë³´</th><th>ìš°ìœ„ ì ìˆ˜</th><th>ê²½ìŸ ê°•ë„</th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map((c,i)=>({name:c.name,score:c.metrics?.[m]??0,col:CANDIDATE_COLORS[i%5]})).sort((a,b)=>b.score-a.score);
    const gap = scores[0].score - (scores[1]?.score??0);
    const intensity = gap<=1?'ğŸ”´ ë§¤ìš°ì¹˜ì—´':gap<=3?'ğŸŸ¡ ì¹˜ì—´':gap<=6?'ğŸŸ¢ ìš°ì„¸':'ğŸ”µ ì••ë„ì ';
    compTbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td><td style="color:${scores[0].col.border};font-weight:700">${scores[0].name}</td><td>+${gap}ì </td><td>${intensity}</td></tr>`;
  });
  compTbl += `</tbody></table>`;

  const bigGap = METRICS.reduce((b,m)=>{const s=candidates.map(c=>c.metrics?.[m]??0);const g=Math.max(...s)-Math.min(...s);return g>b.gap?{m,gap:g}:b},{m:'',gap:0});
  const smlGap = METRICS.reduce((b,m)=>{const s=candidates.map(c=>c.metrics?.[m]??0);const g=Math.max(...s)-Math.min(...s);return g<b.gap?{m,gap:g}:b},{m:METRICS[0],gap:999});

  // â”€â”€ í•­ëª©ë³„ ìƒì„¸ ê²©ì°¨ ì¢…í•© ì„¤ëª… â”€â”€
  const gapByMetric = METRICS.map(m => {
    const leaderScore = leader.metrics?.[m]??0;
    const othersGaps = sortedC.slice(1).map(c=>(c.metrics?.[m]??0)-leaderScore);
    const maxGapAbs = Math.max(...othersGaps.map(g=>Math.abs(g)));
    return { m, leaderScore, maxGap: maxGapAbs, avgGap: othersGaps.length ? othersGaps.reduce((a,b)=>a+b,0)/othersGaps.length : 0 };
  });
  const biggestGapM = gapByMetric.reduce((a,b)=>b.maxGap>a.maxGap?b:a);
  const smallestGapM = gapByMetric.reduce((a,b)=>b.maxGap<a.maxGap?b:a);
  const closest = sortedC.length > 1 ? sortedC[1] : null;
  const closestGap = closest ? leader.total_score - closest.total_score : 0;
  const sum_gaps = summaryBox('í•­ëª©ë³„ ìƒì„¸ ê²©ì°¨ ì¢…í•© ì„¤ëª…', [
    `í•­ëª©ë³„ ìƒì„¸ ê²©ì°¨ í…Œì´ë¸”ì€ 1ìœ„ <strong>${leader.name}(${leader.total_score}ì )</strong>ì„ ê¸°ì¤€ìœ¼ë¡œ ê° í›„ë³´ê°€ 10ê°œ í•­ëª© ê°ê°ì—ì„œ ì–¼ë§ˆë‚˜ ì•ì„œê±°ë‚˜ ë’¤ì²˜ì§€ëŠ”ì§€ë¥¼ ìˆ˜ì¹˜ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. ìŒìˆ˜(-)ëŠ” 1ìœ„ ëŒ€ë¹„ ë¶€ì¡±í•œ ì ìˆ˜, ì–‘ìˆ˜(+)ëŠ” íŠ¹ì • í•­ëª©ì—ì„œ 1ìœ„ë¥¼ ì•ì„  ìˆ˜ì¹˜ì…ë‹ˆë‹¤.`,
    `ê²©ì°¨ê°€ ê°€ì¥ í° í•­ëª©ì€ <strong>${METRIC_LABELS[biggestGapM.m]}</strong>(ìµœëŒ€ ${biggestGapM.maxGap}ì  ì°¨ì´)ìœ¼ë¡œ, ì´ í•­ëª©ì—ì„œì˜ ì„±ê³¼ ê²©ì°¨ê°€ í›„ë³´ ê°„ ì—­ëŸ‰ ì°¨ì´ë¥¼ ê°€ì¥ ëšœë ·í•˜ê²Œ ë“œëŸ¬ëƒ…ë‹ˆë‹¤. ë°˜ë©´ <strong>${METRIC_LABELS[smallestGapM.m]}</strong> í•­ëª©ì€ ê²©ì°¨ê°€ ${smallestGapM.maxGap}ì ìœ¼ë¡œ ê°€ì¥ ì‘ì•„ í›„ë³´ ê°„ ê²½ìŸì´ íŒ½íŒ½í•˜ë©°, ì´ ì˜ì—­ì—ì„œì˜ ë¯¸ì„¸í•œ ì„±ê³¼ ì°¨ì´ê°€ ì „ì²´ íŒì„¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    `${closest ? `2ìœ„ <strong>${closest.name}</strong>ê³¼ì˜ ì¢…í•© ì ìˆ˜ ê²©ì°¨ëŠ” <strong>${closestGap}ì </strong>ì…ë‹ˆë‹¤. ${closestGap <= 15 ? 'ì´ ê²©ì°¨ëŠ” ë‹¨ 1~2ê°œ í•­ëª©ì˜ ì§‘ì¤‘ ê°œì„ ìœ¼ë¡œ ì—­ì „ ê°€ëŠ¥í•œ ë²”ìœ„ì— í•´ë‹¹í•©ë‹ˆë‹¤. íŠ¹íˆ 2ìœ„ í›„ë³´ê°€ ì•ì„œëŠ” ê°œë³„ í•­ëª©ì´ ìˆë‹¤ë©´, í•´ë‹¹ í•­ëª©ì„ ê³µëµ í¬ì¸íŠ¸ë¡œ ì‚¼ëŠ” ì „ëµì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.' : 'ì´ ê²©ì°¨ë¥¼ ì¢íˆê¸° ìœ„í•´ì„œëŠ” ë³µìˆ˜ í•­ëª©ì— ê±¸ì¹œ ì²´ê³„ì ì¸ ì—­ëŸ‰ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.'}` : ''}`,
    `ì´ ë¶„ì„ì˜ í•µì‹¬ í™œìš© í¬ì¸íŠ¸ëŠ” 'ì—­ì „ ê°€ëŠ¥í•œ í•­ëª©'ì„ ì°¾ëŠ” ê²ƒì…ë‹ˆë‹¤. ê²©ì°¨ê°€ 5ì  ì´ë‚´ì¸ í•­ëª©ì€ ë‹¨ê¸°ê°„ì˜ ì§‘ì¤‘ ë…¸ë ¥ìœ¼ë¡œ ìˆœìœ„ ì—­ì „ì´ ê°€ëŠ¥í•œ 'ê³µëµ ëª©í‘œ'ê°€ ë©ë‹ˆë‹¤. ì„ ê±° ìº í”„ëŠ” ì´ í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ ì–´ëŠ í•­ëª©ì— ìì›ì„ ì§‘ì¤‘ íˆ¬ì…í• ì§€ ìš°ì„ ìˆœìœ„ë¥¼ ì„¤ì •í•˜ëŠ” ë° í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  ]);

  // â”€â”€ ê²½ìŸ ìš°ìœ„ ë§¤íŠ¸ë¦­ìŠ¤ ì¢…í•© ì„¤ëª… â”€â”€
  const compData = METRICS.map(m => {
    const scores = candidates.map((c,i)=>({name:c.name,s:c.metrics?.[m]??0,i})).sort((a,b)=>b.s-a.s);
    const gap = scores[0].s - (scores[1]?.s??0);
    const intensity = gap<=1?'ë§¤ìš° ì¹˜ì—´':gap<=3?'ì¹˜ì—´':gap<=6?'ìš°ì„¸':'ì••ë„ì ';
    return { m, leader: scores[0], gap, intensity };
  });
  const fierce = compData.filter(x=>x.intensity==='ë§¤ìš° ì¹˜ì—´'||x.intensity==='ì¹˜ì—´');
  const dominant = compData.filter(x=>x.intensity==='ì••ë„ì ');
  const topLeaderInMatrix = (() => {
    const cnt = {}; compData.forEach(x=>{ cnt[x.leader.name]=(cnt[x.leader.name]||0)+1; });
    return Object.entries(cnt).sort((a,b)=>b[1]-a[1])[0];
  })();
  const sum_comp = summaryBox('í•­ëª©ë³„ ê²½ìŸ ìš°ìœ„ ë§¤íŠ¸ë¦­ìŠ¤ ì¢…í•© ì„¤ëª…', [
    `ê²½ìŸ ìš°ìœ„ ë§¤íŠ¸ë¦­ìŠ¤ëŠ” 10ê°œ í•­ëª©ë³„ë¡œ 'í˜„ì¬ 1ìœ„ í›„ë³´'ì™€ 'ê²½ìŸ ê°•ë„'ë¥¼ ë™ì‹œì— íŒŒì•…í•˜ëŠ” ë¶„ì„ ë„êµ¬ì…ë‹ˆë‹¤. <strong>${topLeaderInMatrix[0]}</strong>ì´(ê°€) ì´ <strong>${topLeaderInMatrix[1]}ê°œ í•­ëª©</strong>ì—ì„œ ê²½ìŸ ìš°ìœ„ë¥¼ ë³´ì´ë©° ê°€ì¥ ê´‘ë²”ìœ„í•œ ì˜ì—­ì—ì„œ ì„ ë‘ë¥¼ ë‹¬ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`,
    `ê²½ìŸ ê°•ë„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³´ë©´, ${fierce.length > 0 ? `<strong>${fierce.map(x=>METRIC_LABELS[x.m]).join(', ')}</strong> í•­ëª©ì€ 'ì¹˜ì—´' ì´ìƒì˜ ê²½ìŸ ê°•ë„ë¥¼ ë³´ì—¬ ì–´ëŠ í›„ë³´ë„ ì•ˆì‹¬í•  ìˆ˜ ì—†ëŠ” 'ë¬´ì£¼ê³µì‚°' êµ¬ê°„ì…ë‹ˆë‹¤.` : 'ë§¤ìš° ì¹˜ì—´í•œ êµ¬ê°„ì´ ì—†ì–´ í•­ëª©ë³„ ìš°ìœ„ê°€ ë¹„êµì  ëª…í™•í•˜ê²Œ êµ¬ë¶„ë©ë‹ˆë‹¤.'} ${dominant.length > 0 ? `ë°˜ë©´ <strong>${dominant.map(x=>METRIC_LABELS[x.m]).join(', ')}</strong>ì€(ëŠ”) 'ì••ë„ì  ìš°ìœ„' êµ¬ê°„ìœ¼ë¡œ, í•´ë‹¹ í•­ëª©ì˜ 1ìœ„ í›„ë³´ê°€ í•µì‹¬ ì°¨ë³„í™” ìì‚°ìœ¼ë¡œ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.` : ''}`,
    `ê²½ìŸ ê°•ë„ê°€ 'ë§¤ìš° ì¹˜ì—´'ì¸ í•­ëª©ë“¤ì€ ì„ ê±° ì „ëµì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì˜ë¯¸ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ë‹¨ 1~2ì ì˜ ì°¨ì´ë¡œ 1ìœ„ê°€ ê²°ì •ë˜ëŠ” ì´ í•­ëª©ë“¤ì—ì„œì˜ ë¯¸ì„¸í•œ ì„±ê³¼ ê°œì„ ì´ ì „ì²´ ìˆœìœ„ë¥¼ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° í›„ë³´ëŠ” ì´ í•­ëª©ë“¤ì—ì„œ êµ¬ì²´ì ì´ê³  ê²€ì¦ ê°€ëŠ¥í•œ ì„±ê³¼ë¥¼ ì œì‹œí•˜ëŠ” ê²ƒì´ ê²½ìŸë ¥ ê°•í™”ì˜ í•µì‹¬ì…ë‹ˆë‹¤.`,
    `ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ì„ì„ í†µí•´ ê° í›„ë³´ì˜ 'ë…ì  ê°•ì  í•­ëª©'(ì••ë„ì  ìš°ìœ„)ê³¼ 'ê³µëµ ê°€ëŠ¥ í•­ëª©'(ì¹˜ì—´í•œ ê²½ìŸ) ì§€ë„ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì§€ë„ëŠ” ìœ ê¶Œìê°€ ê° í›„ë³´ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí•´ì•¼ í•˜ëŠ”ì§€, ê·¸ë¦¬ê³  ê° í›„ë³´ê°€ ì–´ë–¤ ë©”ì‹œì§€ë¥¼ ê°•ì¡°í•´ì•¼ í•˜ëŠ”ì§€ë¥¼ ê²°ì •í•˜ëŠ” ë° í•µì‹¬ì ì¸ ê·¼ê±°ê°€ ë©ë‹ˆë‹¤.`
  ]);

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">4</div>ğŸ¯ ê²©ì°¨ ë¶„ì„</div>
    <div class="card">
      <div class="card-title">ğŸ¥‡ ê¸°ì¤€: <span style="color:${CANDIDATE_COLORS[leader.idx%5].border}">${leader.name}</span> (ì¢…í•© 1ìœ„ Â· ${leader.total_score}ì )</div>
      <div class="table-wrap">${sumTbl}</div>
    </div>
    <div class="card"><div class="card-title">ğŸ“Š í•­ëª©ë³„ ê²©ì°¨ ì°¨íŠ¸ (1ìœ„ ëŒ€ë¹„)</div>
      <div style="height:${60+36*METRICS.length}px"><canvas id="s4_gap"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ í•­ëª©ë³„ ìƒì„¸ ê²©ì°¨</div>
      <div class="table-wrap">${metTbl}</div>
    </div>
    ${sum_gaps}
    <div class="card"><div class="card-title">âš”ï¸ í•­ëª©ë³„ ê²½ìŸ ìš°ìœ„</div>
      <div class="table-wrap">${compTbl}</div>
    </div>
    ${sum_comp}
    <div class="insight-box">
      <strong>ê°€ì¥ í° ê²©ì°¨ í•­ëª©:</strong> ${METRIC_LABELS[bigGap.m]} (${bigGap.gap}ì  ì°¨ì´) &nbsp;|&nbsp;
      <strong>ê°€ì¥ ì‘ì€ ê²©ì°¨:</strong> ${METRIC_LABELS[smlGap.m]} (${smlGap.gap}ì  ì°¨ì´)
    </div>
  </div>`;
}

/* â”€â”€ Section 5: AI ëª¨ë¸ ë¹„êµ â”€â”€ */
function buildSection5(candidates) {
  const AI_ICONS = {claude:'ğŸŸ£',chatgpt:'ğŸŸ¢',gemini:'ğŸ”µ',grok:'ğŸ”´'};
  const AI_BORDER = {claude:'#7c3aed',chatgpt:'#16a34a',gemini:'#2563eb',grok:'#dc2626'};
  const AI_DESCS = {claude:'ì œë„í™”Â·ì§€ì†ê°€ëŠ¥ì„±',chatgpt:'í˜ì‹ ì„±Â·ì˜í–¥ë ¥',gemini:'ê³µê°œë°ì´í„°Â·ì„±ê³¼',grok:'ìµœì‹ ì´ìŠˆÂ·í˜„ì¥'};

  // AI ì ìˆ˜ í…Œì´ë¸”
  let aiTbl = `<table><thead><tr><th>í›„ë³´ì</th>`;
  AI_MODELS.forEach(m => { aiTbl += `<th style="color:${AI_BORDER[m]}">${AI_ICONS[m]} ${AI_LABELS[m]}</th>`; });
  aiTbl += `<th>í‰ê· </th><th>í¸ì°¨</th><th>ì¼ê´€ì„±</th></tr></thead><tbody>`;
  candidates.forEach((c,i) => {
    const col = CANDIDATE_COLORS[i%5];
    const scores = AI_MODELS.map(m=>c.ai_scores?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const cons = std<5?'ë§¤ìš°ë†’ìŒ':std<10?'ë†’ìŒ':std<15?'ë³´í†µ':'ë‚®ìŒ';
    aiTbl += `<tr><td style="color:${col.border};font-weight:700">${c.name}</td>`;
    AI_MODELS.forEach(m=>{ aiTbl += `<td style="font-weight:700">${c.ai_scores?.[m]??'-'}</td>`; });
    aiTbl += `<td><strong>${avg.toFixed(1)}</strong></td><td>${std.toFixed(1)}</td><td>${cons}</td></tr>`;
  });
  // AIë³„ 1ìœ„
  aiTbl += `<tr style="background:#f8fafc;font-size:12px"><td style="color:var(--text-muted);font-weight:600">AIë³„ 1ìœ„</td>`;
  AI_MODELS.forEach(m => {
    const best = candidates.reduce((b,c)=>(c.ai_scores?.[m]??0)>(b.ai_scores?.[m]??0)?c:b);
    const idx = candidates.indexOf(best);
    aiTbl += `<td style="color:${CANDIDATE_COLORS[idx%5].border};font-weight:700;font-size:11px">${best.name}<br>${best.ai_scores?.[m]}</td>`;
  });
  aiTbl += `<td colspan="3"></td></tr></tbody></table>`;

  // AI ì¼ê´€ì„± ë°•ìŠ¤
  const consistRows = candidates.map((c,i) => {
    const col = CANDIDATE_COLORS[i%5];
    const scores = AI_MODELS.map(m=>c.ai_scores?.[m]??0).filter(s=>s>0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const spread = Math.max(...scores)-Math.min(...scores);
    const bars = AI_MODELS.map(m => {
      const s = c.ai_scores?.[m]??0;
      const diff = s - avg;
      return `<div class="ai-consist-bar">
        <div class="al" style="color:#7c3aed">${AI_LABELS[m]}</div>
        <div class="av" style="color:${col.border}">${s}</div>
        <div style="font-size:9px;color:${diff>0?'#16a34a':diff<0?'#dc2626':'#94a3b8'}">${diff>0?'+':''  }${diff.toFixed(1)}</div>
      </div>`;
    }).join('');
    return `<div class="ai-consist-row">
      <div class="ai-consist-name" style="color:${col.border}">${c.name}</div>
      <div class="ai-consist-bars">${bars}</div>
      <div style="font-size:11px;color:var(--text-muted);white-space:nowrap;min-width:80px;text-align:right">í¸ì°¨ <strong>${std.toFixed(1)}</strong> Â· ë²”ìœ„ <strong>${spread}ì </strong></div>
    </div>`;
  }).join('');

  // â”€â”€ AI ëª¨ë¸ë³„ ì ìˆ˜ ë¹„êµ ì¢…í•© ì„¤ëª… â”€â”€
  const modelAvgs = AI_MODELS.map(m => ({
    m, avg: candidates.reduce((a,c)=>a+(c.ai_scores?.[m]??0),0)/candidates.length
  }));
  const highestModel = modelAvgs.reduce((a,b)=>b.avg>a.avg?b:a);
  const lowestModel = modelAvgs.reduce((a,b)=>b.avg<a.avg?b:a);
  const modelRankConsist = candidates.map(c => {
    const ranks = AI_MODELS.map(m => {
      const sorted2 = [...candidates].sort((a,b)=>(b.ai_scores?.[m]??0)-(a.ai_scores?.[m]??0));
      return sorted2.findIndex(x=>x===c)+1;
    });
    return { name: c.name, consistent: new Set(ranks).size === 1 };
  });
  const consistent = modelRankConsist.filter(x=>x.consistent).map(x=>x.name);
  const sum_ai = summaryBox('AI ëª¨ë¸ë³„ ì ìˆ˜ ë¹„êµ ì¢…í•© ì„¤ëª…', [
    `ì´ ë¶„ì„ì—ì„œëŠ” Claude(ì œë„í™”Â·ì§€ì†ê°€ëŠ¥ì„± ì¤‘ì‹¬), ChatGPT(í˜ì‹ ì„±Â·ì‚¬íšŒì  ì˜í–¥ë ¥), Gemini(ê³µê°œ ë°ì´í„°Â·ì„±ê³¼ ì¤‘ì‹¬), Grok(ìµœì‹  ì´ìŠˆÂ·í˜„ì¥ ëŒ€ì‘) ë“± 4ê°œ AI ëª¨ë¸ì´ ê°ìì˜ í‰ê°€ ê´€ì ì—ì„œ í›„ë³´ë“¤ì˜ ì—­ëŸ‰ì„ ì ìˆ˜í™”í–ˆìŠµë‹ˆë‹¤. ëª¨ë¸ë³„ í‰ê·  ì ìˆ˜ì—ì„œ <strong>${AI_LABELS[highestModel.m]}</strong>ì´ ê°€ì¥ ë†’ì€ í‰ê· (${highestModel.avg.toFixed(1)}ì )ì„ ê¸°ë¡í–ˆê³ , <strong>${AI_LABELS[lowestModel.m]}</strong>ì´ ${lowestModel.avg.toFixed(1)}ì ìœ¼ë¡œ ê°€ì¥ ë‚®ì€ í‰ê· ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.`,
    `4ê°œ AIì˜ í›„ë³´ ìˆœìœ„ ì¼ê´€ì„±ì„ ë³´ë©´, ${consistent.length > 0 ? `<strong>${consistent.join(', ')}</strong>ì€(ëŠ”) ëª¨ë“  AI ëª¨ë¸ì—ì„œ ë™ì¼í•œ ìˆœìœ„ë¥¼ ê¸°ë¡í•˜ë©° í‰ê°€ ì‹ ë¢°ë„ê°€ ë†’ìŠµë‹ˆë‹¤.` : 'í›„ë³´ë³„ë¡œ AI ëª¨ë¸ë§ˆë‹¤ ìˆœìœ„ ì°¨ì´ë¥¼ ë³´ì—¬, í‰ê°€ ê´€ì ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í•´ì„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'} ì´ëŸ¬í•œ ì¼ê´€ì„± ì—¬ë¶€ëŠ” í•´ë‹¹ í›„ë³´ì˜ ì—­ëŸ‰ì´ ì–¼ë§ˆë‚˜ ë³´í¸ì ìœ¼ë¡œ ì¸ì •ë°›ëŠ”ì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.`,
    `AI ëª¨ë¸ë³„ ìˆœìœ„í‘œì—ì„œ íŠ¹ì • ëª¨ë¸ì—ì„œë§Œ ìˆœìœ„ê°€ ê¸‰ë“±í•˜ê±°ë‚˜ ê¸‰ë½í•˜ëŠ” í›„ë³´ê°€ ìˆë‹¤ë©´, í•´ë‹¹ AIì˜ í‰ê°€ ê¸°ì¤€ê³¼ í•´ë‹¹ í›„ë³´ì˜ ê°•ì ì´ ì¼ì¹˜í•˜ê±°ë‚˜ ì¶©ëŒí•œë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. Grokì—ì„œ ë†’ì€ ì ìˆ˜ë¥¼ ë°›ì€ í›„ë³´ëŠ” ìµœì‹  ì´ìŠˆ ëŒ€ì‘ê³¼ í˜„ì¥ ë°˜ì‘ì„±ì´ íƒì›”í•˜ë©°, Claudeì—ì„œ ë†’ê²Œ í‰ê°€ëœ í›„ë³´ëŠ” ì •ì±…ì˜ ì œë„í™”Â·ì§€ì†ê°€ëŠ¥ì„±ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.`,
    `4ê°œ AI ëª¨ë¸ì˜ í‰ê· ê°’ì´ ë°”ë¡œ ë³¸ í”Œë«í¼ì˜ ì¢…í•© ì ìˆ˜ ê¸°ë°˜ì´ ë©ë‹ˆë‹¤. ë‹¨ì¼ AI ëª¨ë¸ì˜ ì ìˆ˜ë³´ë‹¤ 4ê°œ ëª¨ë¸ì˜ í‰ê· ì´ í¸í–¥ì„ ì¤„ì´ê³  ë‹¤ê°ì  ê´€ì ì„ ë°˜ì˜í•˜ë¯€ë¡œ ì‹ ë¢°ì„±ì´ ë†’ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ AI í‰ê°€ëŠ” ê³µê°œ ë°ì´í„° ê¸°ë°˜ì´ë©° ê°œì¸ì  ë©´ë‹´ì´ë‚˜ í˜„ì¥ ì‹¤ì‚¬ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`
  ]);

  // â”€â”€ AI í‰ê°€ ì¼ê´€ì„± ì¢…í•© ì„¤ëª… â”€â”€
  const consistData = candidates.map(c => {
    const scores = AI_MODELS.map(m=>c.ai_scores?.[m]??0).filter(s=>s>0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const spread = Math.max(...scores)-Math.min(...scores);
    return { name: c.name, party: c.party, std, spread, ai_scores: c.ai_scores };
  });
  const mostConsist = consistData.reduce((a,b)=>b.std<a.std?b:a);
  const leastConsist = consistData.reduce((a,b)=>b.std>a.std?b:a);
  const leastHighModel = AI_MODELS.reduce((a,m)=>(leastConsist.ai_scores?.[m]??0)>(leastConsist.ai_scores?.[a]??0)?m:a, AI_MODELS[0]);
  const sum_consist = summaryBox('í›„ë³´ë³„ AI í‰ê°€ ì¼ê´€ì„± ì¢…í•© ì„¤ëª…', [
    `AI í‰ê°€ ì¼ê´€ì„± ë¶„ì„ì€ 4ê°œ AI ëª¨ë¸ì´ ë™ì¼ í›„ë³´ë¥¼ ì–¼ë§ˆë‚˜ ë¹„ìŠ·í•˜ê²Œ í‰ê°€í–ˆëŠ”ì§€ë¥¼ ìˆ˜ì¹˜ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. í¸ì°¨(í‘œì¤€í¸ì°¨)ê°€ ë‚®ì„ìˆ˜ë¡ AI ê°„ í•©ì˜ê°€ ë†’ê³  ì‹ ë¢°ë„ê°€ ë†’ìœ¼ë©°, ë†’ì„ìˆ˜ë¡ í‰ê°€ ê´€ì ì— ë”°ë¼ íŒë‹¨ì´ ê°ˆë¦¬ëŠ” 'ë³µí•©ì  í”„ë¡œíŒŒì¼'ì„ ê°€ì§„ í›„ë³´ì„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.`,
    `<strong>${mostConsist.name}</strong>(í‘œì¤€í¸ì°¨ ${mostConsist.std.toFixed(1)}, ë²”ìœ„ ${mostConsist.spread}ì )ì€(ëŠ”) AI ëª¨ë¸ ê°„ ì¼ê´€ì„±ì´ ê°€ì¥ ë†’ìŠµë‹ˆë‹¤. ì´ëŠ” í•´ë‹¹ í›„ë³´ì˜ ì—­ëŸ‰ì´ ì–´ëŠ í‰ê°€ ê´€ì ì—ì„œ ë³´ë”ë¼ë„ ìœ ì‚¬í•˜ê²Œ ì¸ì •ëœë‹¤ëŠ” ì˜ë¯¸ë¡œ, ìœ ê¶Œìì—ê²Œ 'ì˜ˆì¸¡ ê°€ëŠ¥í•˜ê³  ì•ˆì •ì ì¸ í›„ë³´'ë¡œ ì¸ì‹ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.`,
    `ë°˜ë©´ <strong>${leastConsist.name}</strong>(í‘œì¤€í¸ì°¨ ${leastConsist.std.toFixed(1)}, ë²”ìœ„ ${leastConsist.spread}ì )ì€ ëª¨ë¸ ê°„ ì ìˆ˜ ì°¨ì´ê°€ ê°€ì¥ í¬ë©°, íŠ¹íˆ <strong>${AI_LABELS[leastHighModel]}</strong>ì—ì„œ ë†’ì€ ì ìˆ˜ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. ì´ëŠ” íŠ¹ì • í‰ê°€ ê´€ì ì—ì„œ ê°•í•˜ê²Œ ì¸ì •ë°›ëŠ” ì—­ëŸ‰ì´ ìˆìœ¼ë‚˜ ë‹¤ë¥¸ ê´€ì ì—ì„œëŠ” ìƒëŒ€ì ìœ¼ë¡œ ë‚®ê²Œ í‰ê°€ë  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.`,
    `AI ì¼ê´€ì„±ì€ ë³¸ ë³´ê³ ì„œ ì‹ ë¢°ë„ì˜ í•µì‹¬ ì§€í‘œì…ë‹ˆë‹¤. í¸ì°¨ê°€ ë‚®ì€ í›„ë³´ì¼ìˆ˜ë¡ ì¢…í•© ì ìˆ˜ê°€ ì‹¤ì œ ì—­ëŸ‰ì„ ì •í™•íˆ ë°˜ì˜í•  ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë©°, í¸ì°¨ê°€ í° í›„ë³´ëŠ” ì¶”ê°€ì ì¸ ì •ì„±ì  ë¶„ì„ â€” í˜„ì¥ ì¸í„°ë·°, ì‹œë¯¼ í‰ê°€, ì–¸ë¡  ëª¨ë‹ˆí„°ë§ â€” ì„ ë³´ì™„í•´ì•¼ ë” ì •í™•í•œ íŒë‹¨ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
  ]);

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">5</div>ğŸ¤– AI ëª¨ë¸ë³„ ì ìˆ˜ ë¹„êµ</div>
    <div class="card"><div class="card-title">ğŸ“Š AI ëª¨ë¸ Ã— í›„ë³´ì ê·¸ë£¹ ë¹„êµ</div>
      <div style="height:360px"><canvas id="s5_bar"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ AI ëª¨ë¸ë³„ ìƒì„¸ ì ìˆ˜</div>
      <div class="table-wrap">${aiTbl}</div>
    </div>
    ${sum_ai}
    <div class="card"><div class="card-title">ğŸ“ˆ AI ëª¨ë¸ ì¶”ì„¸ ë¹„êµ</div>
      <div style="height:280px"><canvas id="s5_line"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“ í›„ë³´ë³„ AI í‰ê°€ ì¼ê´€ì„±</div>
      ${consistRows}
      <div class="insight-box">í¸ì°¨ê°€ ë‚®ì„ìˆ˜ë¡ AI ëª¨ë¸ ê°„ í‰ê°€ê°€ ì¼ì¹˜í•˜ë©° ì‹ ë¢°ë„ê°€ ë†’ìŠµë‹ˆë‹¤.</div>
    </div>
    ${sum_consist}
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ë“¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSection1Charts(candidates) {
  chartInstances.s1_radar = new Chart(document.getElementById('s1_radar'), {
    type: 'radar',
    data: {
      labels: METRICS.map(m=>METRIC_LABELS[m]),
      datasets: candidates.map((c,i)=>({
        label: c.name,
        data: METRICS.map(m=>c.metrics?.[m]??0),
        borderColor: CANDIDATE_COLORS[i%5].border,
        backgroundColor: CANDIDATE_COLORS[i%5].bg,
        borderWidth: 2, pointRadius: 3,
        pointBackgroundColor: CANDIDATE_COLORS[i%5].border,
      }))
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{r:{min:50,max:100,ticks:{stepSize:10,font:{size:9}},pointLabels:{font:{size:11,weight:'600'}},grid:{color:'#e2e8f0'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:10}}}
    }
  });

  chartInstances.s1_bar = new Chart(document.getElementById('s1_bar'), {
    type: 'bar',
    data: {
      labels: candidates.map(c=>c.name),
      datasets: [{
        label:'ì¢…í•© ì ìˆ˜',
        data: candidates.map(c=>c.total_score),
        backgroundColor: candidates.map((c,i)=>CANDIDATE_COLORS[i%5].bg),
        borderColor: candidates.map((c,i)=>CANDIDATE_COLORS[i%5].border),
        borderWidth:2, borderRadius:6,
      }]
    },
    options: {
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      scales:{x:{min:600,max:1000,grid:{color:'#f1f5f9'},ticks:{font:{size:11}}},y:{ticks:{font:{size:12,weight:'600'}}}},
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.x}ì `}}}
    }
  });
}

function renderSection2Charts(candidates) {
  chartInstances.s2_grouped = new Chart(document.getElementById('s2_grouped'), {
    type: 'bar',
    data: {
      labels: METRICS.map(m=>METRIC_LABELS[m]),
      datasets: candidates.map((c,i)=>({
        label:c.name,
        data:METRICS.map(m=>c.metrics?.[m]??0),
        backgroundColor:CANDIDATE_COLORS[i%5].bg,
        borderColor:CANDIDATE_COLORS[i%5].border,
        borderWidth:2, borderRadius:3,
      }))
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{x:{ticks:{font:{size:10}},grid:{display:false}},y:{min:50,max:100,ticks:{font:{size:10}},grid:{color:'#f1f5f9'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}
    }
  });
}

function renderSection3Charts(candidates) {
  candidates.forEach((c, i) => {
    const col = CANDIDATE_COLORS[i%5];
    chartInstances[`s3_radar_${i}`] = new Chart(document.getElementById(`s3_radar_${i}`), {
      type: 'radar',
      data: {
        labels: METRICS.map(m=>METRIC_LABELS[m]),
        datasets: [{
          label:c.name,
          data:METRICS.map(m=>c.metrics?.[m]??0),
          borderColor:col.border, backgroundColor:col.bg,
          borderWidth:2, pointRadius:2, pointBackgroundColor:col.border,
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        scales:{r:{min:40,max:100,ticks:{display:false},pointLabels:{font:{size:9}},grid:{color:'#e2e8f0'}}},
        plugins:{legend:{display:false}}
      }
    });
  });
}

function renderSection4Charts(candidates, sortedC) {
  const leader = sortedC[0];
  const datasets = sortedC.slice(1).map(c=>({
    label:c.name,
    data:METRICS.map(m=>(c.metrics?.[m]??0)-(leader.metrics?.[m]??0)),
    backgroundColor:CANDIDATE_COLORS[c.idx%5].bg,
    borderColor:CANDIDATE_COLORS[c.idx%5].border,
    borderWidth:2, borderRadius:3,
  }));

  chartInstances.s4_gap = new Chart(document.getElementById('s4_gap'), {
    type:'bar',
    data:{labels:METRICS.map(m=>METRIC_LABELS[m]), datasets},
    options:{
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      scales:{
        x:{ticks:{callback:v=>v>0?'+'+v:v,font:{size:10}},grid:{color:ctx=>ctx.tick.value===0?'#94a3b8':'#f1f5f9'}},
        y:{ticks:{font:{size:11}}}
      },
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.x>0?'+'+ctx.parsed.x:ctx.parsed.x}ì `}}}
    }
  });
}

function renderSection5Charts(candidates) {
  const AI_BORDER_C = {claude:'#7c3aed',chatgpt:'#16a34a',gemini:'#2563eb',grok:'#dc2626'};

  chartInstances.s5_bar = new Chart(document.getElementById('s5_bar'), {
    type:'bar',
    data:{
      labels:candidates.map(c=>c.name),
      datasets:AI_MODELS.map(m=>({
        label:AI_LABELS[m],
        data:candidates.map(c=>c.ai_scores?.[m]??0),
        backgroundColor:AI_BORDER_C[m]+'30',
        borderColor:AI_BORDER_C[m],
        borderWidth:2, borderRadius:3,
      }))
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{x:{ticks:{font:{size:12}},grid:{display:false}},y:{min:650,max:900,ticks:{font:{size:10}},grid:{color:'#f1f5f9'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}
    }
  });

  chartInstances.s5_line = new Chart(document.getElementById('s5_line'), {
    type:'line',
    data:{
      labels:AI_MODELS.map(m=>AI_LABELS[m]),
      datasets:candidates.map((c,i)=>({
        label:c.name,
        data:AI_MODELS.map(m=>c.ai_scores?.[m]??0),
        borderColor:CANDIDATE_COLORS[i%5].border,
        backgroundColor:CANDIDATE_COLORS[i%5].bg,
        borderWidth:2, pointRadius:5, pointBackgroundColor:CANDIDATE_COLORS[i%5].border,
        tension:0.3,
      }))
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{x:{ticks:{font:{size:12,weight:'600'}}},y:{min:650,max:900,grid:{color:'#f1f5f9'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF ì €ì¥ (canvas â†’ img ë³€í™˜ í›„ ì¸ì‡„)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function savePDF() {
  const btn = document.querySelector('.pdf-btn');
  btn.disabled = true;
  btn.innerHTML = 'â³ ì°¨íŠ¸ ë³€í™˜ ì¤‘...';

  // ëª¨ë“  canvasë¥¼ ê³ í•´ìƒë„ imgë¡œ ë³€í™˜ (í™”ë©´ ë¹„ìœ¨ ê·¸ëŒ€ë¡œ ìœ ì§€)
  const canvasEls = Array.from(document.querySelectorAll('#fullReport canvas'));
  const replacements = [];

  for (const canvas of canvasEls) {
    try {
      // í™”ë©´ì— í‘œì‹œëœ ì‹¤ì œ í¬ê¸° ìº¡ì²˜
      const rect = canvas.getBoundingClientRect();
      const img = document.createElement('img');
      img.src = canvas.toDataURL('image/png', 1.0);
      img.className = 'chart-img';
      img.style.cssText = `
        width: 100%;
        height: ${rect.height}px;
        display: block;
        object-fit: contain;
      `;
      replacements.push({ canvas, img, parent: canvas.parentNode });
      canvas.parentNode.replaceChild(img, canvas);
    } catch(e) { console.warn('canvas ë³€í™˜ ì‹¤íŒ¨:', e); }
  }

  btn.innerHTML = 'ğŸ–¨ï¸ ì¸ì‡„ ì°½ ì—´ë¦¼...';

  // ë Œë”ë§ ì•ˆì •í™” ëŒ€ê¸°
  await new Promise(r => setTimeout(r, 600));
  window.print();

  // ì¸ì‡„ í›„ canvas ë³µì›
  setTimeout(() => {
    replacements.forEach(({ img, canvas, parent }) => {
      try {
        if (img.parentNode === parent) parent.replaceChild(canvas, img);
      } catch(e) {}
    });
    btn.disabled = false;
    btn.innerHTML = 'ğŸ“¥ PDFë¡œ ì €ì¥';
  }, 1500);
}
</script>

</body>
</html>
