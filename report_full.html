<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ Â· ElectionAI</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* â”€â”€ í™”ë©´ ë ˆì´ì•„ì›ƒ â”€â”€ */
.top-bar {
  position: sticky; top: 0; z-index: 200;
  background: #1e3a8a; color: white;
  padding: 12px 32px; display: flex; align-items: center; gap: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.top-bar h2 { font-size: 15px; font-weight: 700; flex: 1; }
.pdf-btn {
  display: inline-flex; align-items: center; gap: 8px;
  background: #f59e0b; color: #1c1917; border: none; cursor: pointer;
  padding: 9px 22px; border-radius: 8px; font-family: inherit;
  font-size: 14px; font-weight: 800; transition: all 0.2s;
}
.pdf-btn:hover { background: #d97706; transform: translateY(-1px); }
.back-btn {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.15); color: white; border: none; cursor: pointer;
  padding: 7px 14px; border-radius: 6px; font-family: inherit; font-size: 13px;
  text-decoration: none; transition: background 0.2s;
}
.back-btn:hover { background: rgba(255,255,255,0.25); }

.full-report { max-width: 960px; margin: 0 auto; padding: 32px 24px 80px; }

/* â”€â”€ í‘œì§€ â”€â”€ */
.cover-page {
  background: linear-gradient(160deg, #1e3a8a 0%, #1d4ed8 50%, #2563eb 100%);
  color: white; border-radius: 16px; padding: 56px 48px;
  margin-bottom: 32px; position: relative; overflow: hidden;
}
.cover-page::before {
  content: 'âš–ï¸'; font-size: 200px; opacity: 0.05;
  position: absolute; right: -20px; top: -20px; line-height: 1;
}
.cover-badge {
  display: inline-block; background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.3); padding: 4px 14px;
  border-radius: 20px; font-size: 12px; font-weight: 600; margin-bottom: 20px;
}
.cover-page h1 { font-size: 32px; font-weight: 900; line-height: 1.3; margin-bottom: 12px; }
.cover-page .subtitle { font-size: 16px; opacity: .8; margin-bottom: 32px; }
.cover-meta { display: flex; gap: 32px; flex-wrap: wrap; margin-bottom: 32px; }
.cover-meta-item { }
.cover-meta-item .label { font-size: 11px; opacity: .6; text-transform: uppercase; letter-spacing: .8px; margin-bottom: 3px; }
.cover-meta-item .value { font-size: 16px; font-weight: 700; }
.cover-candidates { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 28px; }
.cover-candidate-chip {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 18px; border-radius: 24px; font-size: 14px; font-weight: 700;
}
.cover-candidate-chip .score { opacity: .8; font-size: 12px; margin-left: 6px; }

/* â”€â”€ ì„¹ì…˜ êµ¬ë¶„ â”€â”€ */
.report-section { margin-bottom: 40px; }
.section-header {
  display: flex; align-items: center; gap: 12px;
  background: linear-gradient(90deg, #1e3a8a, #1d4ed8);
  color: white; padding: 14px 20px; border-radius: 10px;
  margin-bottom: 20px; font-size: 18px; font-weight: 800;
}
.section-num {
  background: rgba(255,255,255,0.2); width: 30px; height: 30px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 900; flex-shrink: 0;
}

/* â”€â”€ ìˆœìœ„ ì¹´ë“œ ê·¸ë¦¬ë“œ â”€â”€ */
.rank-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 14px; margin-bottom: 20px; }
.rk-card {
  background: white; border-radius: 12px; padding: 18px 16px;
  border: 2px solid var(--border); box-shadow: var(--shadow);
  position: relative; overflow: hidden;
}
.rk-card .num { font-size: 56px; font-weight: 900; opacity:.05; position:absolute; right:8px; top:0; line-height:1; }
.rk-card .rank-tag-lg {
  width: 32px; height: 32px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:14px; margin-bottom:10px;
}
.rk-card .name { font-size:17px; font-weight:800; }
.rk-card .party { font-size:11px; color:var(--text-muted); margin-bottom:8px; }
.rk-card .big { font-size:34px; font-weight:900; }
.rk-card .prog { height:6px; background:#f1f5f9; border-radius:3px; margin-top:10px; overflow:hidden; }
.rk-card .prog-fill { height:100%; border-radius:3px; }

/* â”€â”€ ì°¨íŠ¸ ê·¸ë¦¬ë“œ â”€â”€ */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.chart-box { background:white; border:1px solid var(--border); border-radius:12px; padding:18px; }
.chart-box h3 { font-size:13px; font-weight:700; color:var(--text-muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:.4px; }

/* â”€â”€ í”„ë¡œíŒŒì¼ ê·¸ë¦¬ë“œ â”€â”€ */
.profile-print-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:16px; }
.pp-card { background:white; border-radius:12px; overflow:hidden; border:1px solid var(--border); }
.pp-head { padding:16px 20px; color:white; }
.pp-head .name { font-size:18px; font-weight:900; margin-bottom:2px; }
.pp-head .sub { font-size:12px; opacity:.85; margin-bottom:8px; }
.pp-head .sc { font-size:30px; font-weight:900; }
.pp-body { padding:16px 20px; }
.pp-info { font-size:12px; color:var(--text-muted); margin-bottom:4px; }
.pp-info strong { color:var(--text); }
.pp-tags { display:flex; flex-wrap:wrap; gap:5px; margin:8px 0; }
.pp-tag { padding:3px 9px; border-radius:12px; font-size:11px; font-weight:600; }
.pp-tag.s { background:#dcfce7; color:#166534; }
.pp-tag.w { background:#fee2e2; color:#991b1b; }
.pp-sum { font-size:12px; color:var(--text-muted); line-height:1.6; margin-top:8px; border-top:1px solid var(--border); padding-top:8px; }
.pp-ai-row { display:grid; grid-template-columns:repeat(4,1fr); gap:4px; margin-top:10px; text-align:center; }
.pp-ai-cell { background:#f8fafc; border-radius:6px; padding:5px 3px; }
.pp-ai-cell .lbl { font-size:9px; font-weight:700; }
.pp-ai-cell .val { font-size:13px; font-weight:800; }

/* â”€â”€ AI ì¼ê´€ì„± â”€â”€ */
.ai-consist-row {
  display:flex; align-items:center; gap:12px;
  background:white; border:1px solid var(--border); border-radius:10px;
  padding:14px 16px; margin-bottom:10px;
}
.ai-consist-name { font-weight:700; width:80px; flex-shrink:0; }
.ai-consist-bars { flex:1; display:flex; gap:6px; }
.ai-consist-bar { flex:1; text-align:center; }
.ai-consist-bar .al { font-size:10px; font-weight:600; }
.ai-consist-bar .av { font-size:14px; font-weight:800; }

/* â”€â”€ ì¸ì‡„ ìŠ¤íƒ€ì¼ â”€â”€ */
@page {
  size: A4;
  margin: 14mm 14mm 22mm 14mm;
  @bottom-right {
    content: counter(page) " / " counter(pages);
    font-size: 9pt;
    color: #94a3b8;
    font-family: 'Noto Sans KR', sans-serif;
  }
}

@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  .top-bar, .app-header, .main-nav { display: none !important; }
  body { background: white !important; margin: 0; }
  .full-report { max-width: 100%; padding: 0; }

  /* í‘œì§€ */
  .cover-page {
    border-radius: 0;
    margin: 0 0 20px;
    padding: 40px 32px;
    background: linear-gradient(160deg, #1e3a8a 0%, #1d4ed8 50%, #2563eb 100%) !important;
    color: white !important;
  }
  .cover-badge {
    background: rgba(255,255,255,0.15) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    color: white !important;
  }
  .cover-candidate-chip {
    background: rgba(255,255,255,0.15) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    color: white !important;
  }

  /* ì„¹ì…˜ í—¤ë” */
  .section-header {
    background: linear-gradient(90deg, #1e3a8a, #1d4ed8) !important;
    color: white !important;
    font-size: 13pt;
  }
  .section-num {
    background: rgba(255,255,255,0.2) !important;
    color: white !important;
  }

  /* ì„¹ì…˜ í˜ì´ì§€ ë¶„ë¦¬ */
  .report-section { page-break-before: always; }
  .report-section:first-child { page-break-before: auto; }

  /* ì¹´ë“œ */
  .card, .rk-card, .pp-card, .chart-box {
    box-shadow: none !important;
    break-inside: avoid;
    border: 1px solid #e2e8f0 !important;
  }

  /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
  .two-col { grid-template-columns: 1fr 1fr; }
  .rank-cards-grid { grid-template-columns: repeat(4, 1fr); }
  .profile-print-grid { grid-template-columns: repeat(2, 1fr); }

  /* ìˆœìœ„ íƒœê·¸ ìƒ‰ìƒ ìœ ì§€ */
  .rank-1 { background: #fef3c7 !important; color: #92400e !important; }
  .rank-2 { background: #f1f5f9 !important; color: #475569 !important; }
  .rank-3 { background: #fef9c3 !important; color: #713f12 !important; }

  /* pp-tag ìƒ‰ìƒ ìœ ì§€ */
  .pp-tag.s { background: #dcfce7 !important; color: #166534 !important; }
  .pp-tag.w { background: #fee2e2 !important; color: #991b1b !important; }

  /* insight-box */
  .insight-box {
    background: #eff6ff !important;
    border: 1px solid #bfdbfe !important;
    color: #1e40af !important;
  }

  /* í‘œ */
  table { font-size: 10pt; }
  h1 { font-size: 22pt; }

  /* ì´ë¯¸ì§€(ì°¨íŠ¸ ë³€í™˜ë³¸) */
  img.chart-img { max-width: 100% !important; height: auto !important; display: block; }
}
</style>
</head>
<body>

<!-- ìƒë‹¨ ë°” -->
<div class="top-bar no-print">
  <a href="report_compare.html" class="back-btn">â† ëŒì•„ê°€ê¸°</a>
  <h2>ğŸ“‹ ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ â€” ëª¨ë“  í•­ëª© í†µí•©</h2>
  <button class="pdf-btn" onclick="savePDF()">ğŸ“¥ PDFë¡œ ì €ì¥</button>
</div>

<div class="full-report" id="fullReport">
  <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
</div>

<script src="js/shared.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì²´ ë³´ê³ ì„œ ë Œë”ë§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const chartInstances = {};

document.addEventListener('DOMContentLoaded', async () => {
  const data = getData();
  if (!data || !data.candidates?.length) {
    document.getElementById('fullReport').innerHTML = `
      <div class="no-data" style="padding:80px 20px;text-align:center">
        <div style="font-size:56px;margin-bottom:16px">ğŸ“‚</div>
        <h3 style="font-size:22px;color:#64748b">ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p style="color:#94a3b8;margin-bottom:24px">í™ˆì—ì„œ PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
        <a href="index.html" class="btn btn-primary">ğŸ  í™ˆìœ¼ë¡œ ì´ë™</a>
      </div>`;
    return;
  }

  const { candidates, district, analysis_date } = data;
  const n = candidates.length;
  const totalRanks = calcTotalRankings(candidates);
  const sortedC = [...candidates].map((c,i)=>({...c,idx:i})).sort((a,b)=>b.total_score-a.total_score);

  let html = buildCover(candidates, sortedC, district, analysis_date)
    + buildSection1(candidates, sortedC, totalRanks)
    + buildSection2(candidates)
    + buildSection3(candidates, totalRanks)
    + buildSection4(candidates, sortedC)
    + buildSection5(candidates);

  document.getElementById('fullReport').innerHTML = html;

  // ì°¨íŠ¸ ë Œë”ë§ (ìˆœì„œëŒ€ë¡œ)
  renderSection1Charts(candidates);
  renderSection2Charts(candidates);
  renderSection3Charts(candidates);
  renderSection4Charts(candidates, sortedC);
  renderSection5Charts(candidates);
});

/* â”€â”€ í‘œì§€ â”€â”€ */
function buildCover(candidates, sortedC, district, analysis_date) {
  const chips = sortedC.map((c,i) => {
    const col = CANDIDATE_COLORS[c.idx%5];
    return `<div class="cover-candidate-chip" style="border-color:${col.border}cc">
      ${c.name} <span class="score">${c.total_score}ì </span>
    </div>`;
  }).join('');

  return `
  <div class="cover-page">
    <div class="cover-badge">ElectionAI Â· AI ê¸°ë°˜ ì„ ê±° í›„ë³´ì ë¶„ì„ ì‹œìŠ¤í…œ</div>
    <h1>ì„ ê±° í›„ë³´ì<br>ì¢…í•© ë¹„êµ ë¶„ì„ ë³´ê³ ì„œ</h1>
    <div class="subtitle">10ê°œ ì§€í‘œ ê¸°ë°˜ ì •ëŸ‰ í‰ê°€ Â· AI ëª¨ë¸ í†µí•© ë¶„ì„</div>
    <div class="cover-meta">
      <div class="cover-meta-item">
        <div class="label">ì„ ê±°êµ¬</div>
        <div class="value">${district || 'ì„ ê±°êµ¬'}</div>
      </div>
      <div class="cover-meta-item">
        <div class="label">ë¶„ì„ ì¼ì</div>
        <div class="value">${analysis_date || new Date().toISOString().split('T')[0]}</div>
      </div>
      <div class="cover-meta-item">
        <div class="label">ë¶„ì„ í›„ë³´</div>
        <div class="value">${candidates.length}ëª…</div>
      </div>
      <div class="cover-meta-item">
        <div class="label">í‰ê°€ ì§€í‘œ</div>
        <div class="value">10ê°œ í•­ëª©</div>
      </div>
    </div>
    <div style="font-size:12px;opacity:.6;margin-bottom:8px">í›„ë³´ì ì¢…í•© ìˆœìœ„</div>
    <div class="cover-candidates">${chips}</div>
  </div>`;
}

/* â”€â”€ Section 1: ì¢…í•© ë¹„êµ â”€â”€ */
function buildSection1(candidates, sortedC, totalRanks) {
  const rankCards = sortedC.map((c, rank) => {
    const col = CANDIDATE_COLORS[c.idx%5];
    const g = scoreGrade(c.total_score);
    const rankCls = rank===0?'rank-1':rank===1?'rank-2':rank===2?'rank-3':'rank-other';
    return `
    <div class="rk-card" style="border-color:${col.border}">
      <div class="num">${rank+1}</div>
      <div class="rank-tag-lg ${rankCls}">${rank+1}</div>
      <div class="name" style="color:${col.border}">${c.name}</div>
      <div class="party">${c.party}</div>
      <div>
        <span class="big" style="color:${col.border}">${c.total_score}</span>
        <span style="font-size:13px;color:var(--text-muted)">ì </span>
      </div>
      <div style="font-size:11px;color:${col.border};font-weight:600;margin-top:3px">${g.label}ë“±ê¸‰ Â· ${g.desc}</div>
      <div class="prog"><div class="prog-fill" style="width:${(c.total_score/1000)*100}%;background:${col.border}"></div></div>
    </div>`;
  }).join('');

  // í•­ëª©ë³„ ìµœê³  ì ìˆ˜ í…Œì´ë¸”
  let tbl = `<table><thead><tr><th>í‰ê°€ í•­ëª©</th>`;
  sortedC.forEach(c => { tbl += `<th style="color:${CANDIDATE_COLORS[c.idx%5].border}">${c.name}</th>`; });
  tbl += `<th>ìµœê³ </th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map((c,i)=>({name:c.name,score:c.metrics?.[m]??0,col:CANDIDATE_COLORS[i%5]}));
    const max = Math.max(...scores.map(s=>s.score));
    tbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td>`;
    sortedC.forEach(c => {
      const s = c.metrics?.[m]??0;
      tbl += `<td style="${s===max?`background:${CANDIDATE_COLORS[c.idx%5].light};font-weight:700;color:${CANDIDATE_COLORS[c.idx%5].text}`:''}">${s}${s===max?' â˜…':''}</td>`;
    });
    tbl += `<td><strong>${max}</strong></td></tr>`;
  });
  tbl += `</tbody></table>`;

  // ì¸ì‚¬ì´íŠ¸
  const top = sortedC[0], bot = sortedC[sortedC.length-1];
  const insight = `<strong style="color:${CANDIDATE_COLORS[top.idx%5].border}">${top.name}</strong>ì´(ê°€) ${top.total_score}ì ìœ¼ë¡œ 1ìœ„.
    ${sortedC.length>1?`2ìœ„ ${sortedC[1].name}(${sortedC[1].total_score}ì )ê³¼ì˜ ê²©ì°¨: <strong>${top.total_score-sortedC[1].total_score}ì </strong>. `:''}
    ${sortedC.length>2?`ìµœí•˜ìœ„ ${bot.name}(${bot.total_score}ì )ê³¼ì˜ ê²©ì°¨: <strong>${top.total_score-bot.total_score}ì </strong>.`:''}`;

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">1</div>ğŸ“Š ì¢…í•© ë¹„êµ ë¶„ì„</div>
    <div class="card"><div class="card-title">ğŸ† ì¢…í•© ìˆœìœ„</div>
      <div class="rank-cards-grid">${rankCards}</div>
    </div>
    <div class="two-col">
      <div class="chart-box"><h3>ğŸ•¸ï¸ 10ê°œ í•­ëª© ë ˆì´ë” ë¹„êµ</h3>
        <div style="height:300px"><canvas id="s1_radar"></canvas></div>
      </div>
      <div class="chart-box"><h3>ğŸ“Š ì¢…í•© ì ìˆ˜ ë§‰ëŒ€</h3>
        <div style="height:300px"><canvas id="s1_bar"></canvas></div>
      </div>
    </div>
    <div class="card"><div class="card-title">ğŸ¯ í•­ëª©ë³„ ìµœê³  ì ìˆ˜ í›„ë³´</div>
      <div class="table-wrap">${tbl}</div>
    </div>
    <div class="insight-box">${insight}</div>
  </div>`;
}

/* â”€â”€ Section 2: ì ìˆ˜ ìƒì„¸ â”€â”€ */
function buildSection2(candidates) {
  const n = candidates.length;

  // íˆíŠ¸ë§µ í…Œì´ë¸”
  let tbl = `<table><thead><tr><th>í•­ëª©</th>`;
  candidates.forEach((c,i) => { tbl += `<th style="color:${CANDIDATE_COLORS[i%5].border}">${c.name}</th>`; });
  tbl += `<th>í‰ê· </th><th>ìµœê³ </th><th>ìµœì €</th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map(c=>c.metrics?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/n;
    const max = Math.max(...scores), min = Math.min(...scores);
    tbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td>`;
    scores.forEach((s,i) => {
      const isMax=s===max, isMin=s===min, col=CANDIDATE_COLORS[i%5];
      tbl += `<td style="${isMax?`background:${col.light};font-weight:800;color:${col.text}`:isMin?'background:#fff7ed;color:#92400e;font-weight:700':''}">${s}${isMax?'â–²':isMin?'â–¼':''}</td>`;
    });
    tbl += `<td>${avg.toFixed(1)}</td><td style="color:var(--success);font-weight:700">${max}</td><td style="color:var(--danger);font-weight:700">${min}</td></tr>`;
  });
  tbl += `</tbody></table>`;

  // í‘œì¤€í¸ì°¨ í…Œì´ë¸”
  let stdTbl = `<table><thead><tr><th>í›„ë³´ì</th>`;
  METRICS.forEach(m => { stdTbl += `<th>${METRIC_LABELS[m].replace(' ','<br>')}</th>`; });
  stdTbl += `<th>í‘œì¤€í¸ì°¨</th><th>ê· í˜•ì„±</th></tr></thead><tbody>`;
  candidates.forEach((c,i) => {
    const scores = METRICS.map(m=>c.metrics?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const col = CANDIDATE_COLORS[i%5];
    stdTbl += `<tr><td style="color:${col.border};font-weight:700">${c.name}</td>`;
    scores.forEach(s => { stdTbl += `<td>${s}</td>`; });
    stdTbl += `<td><strong>${std.toFixed(1)}</strong></td><td>${std<5?'ğŸŸ¢ ê· í˜•':std<8?'ğŸŸ¡ ë³´í†µ':'ğŸ”´ í¸ì¤‘'}</td></tr>`;
  });
  stdTbl += `</tbody></table>`;

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">2</div>ğŸ“ˆ 10ê°œ í•­ëª© ì ìˆ˜ ìƒì„¸</div>
    <div class="card"><div class="card-title">ğŸ”¥ ì ìˆ˜ íˆíŠ¸ë§µ</div>
      <div class="table-wrap">${tbl}</div>
      <div class="insight-box" style="margin-top:10px">â–² í•´ë‹¹ í•­ëª© ìµœê³   |  â–¼ í•´ë‹¹ í•­ëª© ìµœì €</div>
    </div>
    <div class="card"><div class="card-title">ğŸ“Š í•­ëª©ë³„ ê·¸ë£¹ ë¹„êµ</div>
      <div style="height:360px"><canvas id="s2_grouped"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“ ê· í˜•ì„± ë¶„ì„ (í‘œì¤€í¸ì°¨)</div>
      <div class="table-wrap">${stdTbl}</div>
    </div>
  </div>`;
}

/* â”€â”€ Section 3: í›„ë³´ì í”„ë¡œíŒŒì¼ â”€â”€ */
function buildSection3(candidates, totalRanks) {
  const cards = candidates.map((c, i) => {
    const col = CANDIDATE_COLORS[i%5];
    const rank = totalRanks[i];
    const g = scoreGrade(c.total_score);
    const topM = METRICS.map(m=>({m,s:c.metrics?.[m]??0})).sort((a,b)=>b.s-a.s).slice(0,3);
    const botM = METRICS.map(m=>({m,s:c.metrics?.[m]??0})).sort((a,b)=>a.s-b.s).slice(0,3);
    const aiRow = AI_MODELS.map(m => `
      <div class="pp-ai-cell">
        <div class="lbl" style="color:${col.border}">${AI_LABELS[m]}</div>
        <div class="val" style="color:${col.border}">${c.ai_scores?.[m]??'-'}</div>
      </div>`).join('');

    return `
    <div class="pp-card">
      <div class="pp-head" style="background:linear-gradient(135deg,${col.border}ee,${col.border})">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">${c.name}</div>
            <div class="sub">${c.party} Â· ${c.position||''}</div>
            <div class="sc">${c.total_score}ì  <span style="font-size:13px;opacity:.8">${g.label}ë“±ê¸‰</span></div>
          </div>
          <div style="background:rgba(255,255,255,0.2);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px">${rank}</div>
        </div>
      </div>
      <div class="pp-body">
        ${c.education?`<div class="pp-info"><strong>í•™ë ¥</strong> ${c.education}</div>`:''}
        ${c.career?`<div class="pp-info"><strong>ê²½ë ¥</strong> ${c.career}</div>`:''}
        <div style="height:180px;margin:12px 0"><canvas id="s3_radar_${i}"></canvas></div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">ê°•ì  í•­ëª©</div>
        <div class="pp-tags">${topM.map(x=>`<span class="pp-tag s">${METRIC_LABELS[x.m]} ${x.s}</span>`).join('')}${(c.strengths||[]).map(s=>`<span class="pp-tag s">${s}</span>`).join('')}</div>
        <div style="font-size:11px;color:var(--text-muted);margin:6px 0">ê°œì„  í•­ëª©</div>
        <div class="pp-tags">${botM.map(x=>`<span class="pp-tag w">${METRIC_LABELS[x.m]} ${x.s}</span>`).join('')}${(c.weaknesses||[]).map(s=>`<span class="pp-tag w">${s}</span>`).join('')}</div>
        ${c.summary?`<div class="pp-sum">${c.summary}</div>`:''}
        <div class="pp-ai-row">${aiRow}</div>
      </div>
    </div>`;
  }).join('');

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">3</div>ğŸ‘¤ í›„ë³´ì í”„ë¡œíŒŒì¼</div>
    <div class="profile-print-grid">${cards}</div>
  </div>`;
}

/* â”€â”€ Section 4: ê²©ì°¨ ë¶„ì„ â”€â”€ */
function buildSection4(candidates, sortedC) {
  const leader = sortedC[0];
  const n = candidates.length;

  // ì¢…í•© ê²©ì°¨ í…Œì´ë¸”
  let sumTbl = `<table><thead><tr><th>ìˆœìœ„</th><th>í›„ë³´ì</th><th>ì¢…í•© ì ìˆ˜</th><th>1ìœ„ ëŒ€ë¹„ ê²©ì°¨</th><th>ë¹„ìœ¨</th></tr></thead><tbody>`;
  sortedC.forEach((c, rank) => {
    const gap = c.total_score - leader.total_score;
    const pct = ((c.total_score/leader.total_score)*100).toFixed(1);
    const col = CANDIDATE_COLORS[c.idx%5];
    sumTbl += `<tr>
      <td>${rankTag(rank+1)}</td>
      <td style="color:${col.border};font-weight:700">${c.name}</td>
      <td style="font-weight:800;font-size:14px">${c.total_score}ì </td>
      <td style="font-weight:700;color:${gap===0?'var(--text-muted)':'var(--warning)'}">${gap===0?'ê¸°ì¤€':(gap>0?'+':'')+gap+'ì '}</td>
      <td>${pct}%</td>
    </tr>`;
  });
  sumTbl += `</tbody></table>`;

  // í•­ëª©ë³„ ê²©ì°¨ í…Œì´ë¸”
  let metTbl = `<table><thead><tr><th>í•­ëª©</th><th>${leader.name}<br>(ê¸°ì¤€)</th>`;
  sortedC.slice(1).forEach(c => { metTbl += `<th style="color:${CANDIDATE_COLORS[c.idx%5].border}">${c.name}<br>ê²©ì°¨</th>`; });
  metTbl += `<th>ìµœëŒ€ê²©ì°¨</th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const ls = leader.metrics?.[m]??0;
    const gaps = sortedC.slice(1).map(c=>(c.metrics?.[m]??0)-ls);
    const maxG = Math.max(...gaps.map(g=>Math.abs(g)));
    metTbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td><td style="font-weight:700">${ls}</td>`;
    gaps.forEach((g,ii)=>{
      const col = CANDIDATE_COLORS[sortedC[ii+1].idx%5];
      metTbl += `<td style="color:${g>0?'var(--success)':g<0?'var(--warning)':'var(--text-muted)'};font-weight:700">${g>0?'+'+g:g}</td>`;
    });
    metTbl += `<td style="font-weight:700">${maxG}ì </td></tr>`;
  });
  metTbl += `</tbody></table>`;

  // ê²½ìŸ ìš°ìœ„ í…Œì´ë¸”
  let compTbl = `<table><thead><tr><th>í•­ëª©</th><th>1ìœ„ í›„ë³´</th><th>ìš°ìœ„ ì ìˆ˜</th><th>ê²½ìŸ ê°•ë„</th></tr></thead><tbody>`;
  METRICS.forEach(m => {
    const scores = candidates.map((c,i)=>({name:c.name,score:c.metrics?.[m]??0,col:CANDIDATE_COLORS[i%5]})).sort((a,b)=>b.score-a.score);
    const gap = scores[0].score - (scores[1]?.score??0);
    const intensity = gap<=1?'ğŸ”´ ë§¤ìš°ì¹˜ì—´':gap<=3?'ğŸŸ¡ ì¹˜ì—´':gap<=6?'ğŸŸ¢ ìš°ì„¸':'ğŸ”µ ì••ë„ì ';
    compTbl += `<tr><td><strong>${METRIC_LABELS[m]}</strong></td><td style="color:${scores[0].col.border};font-weight:700">${scores[0].name}</td><td>+${gap}ì </td><td>${intensity}</td></tr>`;
  });
  compTbl += `</tbody></table>`;

  const bigGap = METRICS.reduce((b,m)=>{const s=candidates.map(c=>c.metrics?.[m]??0);const g=Math.max(...s)-Math.min(...s);return g>b.gap?{m,gap:g}:b},{m:'',gap:0});
  const smlGap = METRICS.reduce((b,m)=>{const s=candidates.map(c=>c.metrics?.[m]??0);const g=Math.max(...s)-Math.min(...s);return g<b.gap?{m,gap:g}:b},{m:METRICS[0],gap:999});

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">4</div>ğŸ¯ ê²©ì°¨ ë¶„ì„</div>
    <div class="card">
      <div class="card-title">ğŸ¥‡ ê¸°ì¤€: <span style="color:${CANDIDATE_COLORS[leader.idx%5].border}">${leader.name}</span> (ì¢…í•© 1ìœ„ Â· ${leader.total_score}ì )</div>
      <div class="table-wrap">${sumTbl}</div>
    </div>
    <div class="card"><div class="card-title">ğŸ“Š í•­ëª©ë³„ ê²©ì°¨ ì°¨íŠ¸ (1ìœ„ ëŒ€ë¹„)</div>
      <div style="height:${60+36*METRICS.length}px"><canvas id="s4_gap"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ í•­ëª©ë³„ ìƒì„¸ ê²©ì°¨</div>
      <div class="table-wrap">${metTbl}</div>
    </div>
    <div class="card"><div class="card-title">âš”ï¸ í•­ëª©ë³„ ê²½ìŸ ìš°ìœ„</div>
      <div class="table-wrap">${compTbl}</div>
    </div>
    <div class="insight-box">
      <strong>ê°€ì¥ í° ê²©ì°¨ í•­ëª©:</strong> ${METRIC_LABELS[bigGap.m]} (${bigGap.gap}ì  ì°¨ì´) &nbsp;|&nbsp;
      <strong>ê°€ì¥ ì‘ì€ ê²©ì°¨:</strong> ${METRIC_LABELS[smlGap.m]} (${smlGap.gap}ì  ì°¨ì´)
    </div>
  </div>`;
}

/* â”€â”€ Section 5: AI ëª¨ë¸ ë¹„êµ â”€â”€ */
function buildSection5(candidates) {
  const AI_ICONS = {claude:'ğŸŸ£',chatgpt:'ğŸŸ¢',gemini:'ğŸ”µ',grok:'ğŸ”´'};
  const AI_BORDER = {claude:'#7c3aed',chatgpt:'#16a34a',gemini:'#2563eb',grok:'#dc2626'};
  const AI_DESCS = {claude:'ì œë„í™”Â·ì§€ì†ê°€ëŠ¥ì„±',chatgpt:'í˜ì‹ ì„±Â·ì˜í–¥ë ¥',gemini:'ê³µê°œë°ì´í„°Â·ì„±ê³¼',grok:'ìµœì‹ ì´ìŠˆÂ·í˜„ì¥'};

  // AI ì ìˆ˜ í…Œì´ë¸”
  let aiTbl = `<table><thead><tr><th>í›„ë³´ì</th>`;
  AI_MODELS.forEach(m => { aiTbl += `<th style="color:${AI_BORDER[m]}">${AI_ICONS[m]} ${AI_LABELS[m]}</th>`; });
  aiTbl += `<th>í‰ê· </th><th>í¸ì°¨</th><th>ì¼ê´€ì„±</th></tr></thead><tbody>`;
  candidates.forEach((c,i) => {
    const col = CANDIDATE_COLORS[i%5];
    const scores = AI_MODELS.map(m=>c.ai_scores?.[m]??0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const cons = std<5?'ë§¤ìš°ë†’ìŒ':std<10?'ë†’ìŒ':std<15?'ë³´í†µ':'ë‚®ìŒ';
    aiTbl += `<tr><td style="color:${col.border};font-weight:700">${c.name}</td>`;
    AI_MODELS.forEach(m=>{ aiTbl += `<td style="font-weight:700">${c.ai_scores?.[m]??'-'}</td>`; });
    aiTbl += `<td><strong>${avg.toFixed(1)}</strong></td><td>${std.toFixed(1)}</td><td>${cons}</td></tr>`;
  });
  // AIë³„ 1ìœ„
  aiTbl += `<tr style="background:#f8fafc;font-size:12px"><td style="color:var(--text-muted);font-weight:600">AIë³„ 1ìœ„</td>`;
  AI_MODELS.forEach(m => {
    const best = candidates.reduce((b,c)=>(c.ai_scores?.[m]??0)>(b.ai_scores?.[m]??0)?c:b);
    const idx = candidates.indexOf(best);
    aiTbl += `<td style="color:${CANDIDATE_COLORS[idx%5].border};font-weight:700;font-size:11px">${best.name}<br>${best.ai_scores?.[m]}</td>`;
  });
  aiTbl += `<td colspan="3"></td></tr></tbody></table>`;

  // AI ì¼ê´€ì„± ë°•ìŠ¤
  const consistRows = candidates.map((c,i) => {
    const col = CANDIDATE_COLORS[i%5];
    const scores = AI_MODELS.map(m=>c.ai_scores?.[m]??0).filter(s=>s>0);
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
    const std = Math.sqrt(scores.reduce((s,v)=>s+Math.pow(v-avg,2),0)/scores.length);
    const spread = Math.max(...scores)-Math.min(...scores);
    const bars = AI_MODELS.map(m => {
      const s = c.ai_scores?.[m]??0;
      const diff = s - avg;
      return `<div class="ai-consist-bar">
        <div class="al" style="color:#7c3aed">${AI_LABELS[m]}</div>
        <div class="av" style="color:${col.border}">${s}</div>
        <div style="font-size:9px;color:${diff>0?'#16a34a':diff<0?'#dc2626':'#94a3b8'}">${diff>0?'+':''  }${diff.toFixed(1)}</div>
      </div>`;
    }).join('');
    return `<div class="ai-consist-row">
      <div class="ai-consist-name" style="color:${col.border}">${c.name}</div>
      <div class="ai-consist-bars">${bars}</div>
      <div style="font-size:11px;color:var(--text-muted);white-space:nowrap;min-width:80px;text-align:right">í¸ì°¨ <strong>${std.toFixed(1)}</strong> Â· ë²”ìœ„ <strong>${spread}ì </strong></div>
    </div>`;
  }).join('');

  return `
  <div class="report-section">
    <div class="section-header"><div class="section-num">5</div>ğŸ¤– AI ëª¨ë¸ë³„ ì ìˆ˜ ë¹„êµ</div>
    <div class="card"><div class="card-title">ğŸ“Š AI ëª¨ë¸ Ã— í›„ë³´ì ê·¸ë£¹ ë¹„êµ</div>
      <div style="height:360px"><canvas id="s5_bar"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ AI ëª¨ë¸ë³„ ìƒì„¸ ì ìˆ˜</div>
      <div class="table-wrap">${aiTbl}</div>
    </div>
    <div class="card"><div class="card-title">ğŸ“ˆ AI ëª¨ë¸ ì¶”ì„¸ ë¹„êµ</div>
      <div style="height:280px"><canvas id="s5_line"></canvas></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“ í›„ë³´ë³„ AI í‰ê°€ ì¼ê´€ì„±</div>
      ${consistRows}
      <div class="insight-box">í¸ì°¨ê°€ ë‚®ì„ìˆ˜ë¡ AI ëª¨ë¸ ê°„ í‰ê°€ê°€ ì¼ì¹˜í•˜ë©° ì‹ ë¢°ë„ê°€ ë†’ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ë“¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSection1Charts(candidates) {
  chartInstances.s1_radar = new Chart(document.getElementById('s1_radar'), {
    type: 'radar',
    data: {
      labels: METRICS.map(m=>METRIC_LABELS[m]),
      datasets: candidates.map((c,i)=>({
        label: c.name,
        data: METRICS.map(m=>c.metrics?.[m]??0),
        borderColor: CANDIDATE_COLORS[i%5].border,
        backgroundColor: CANDIDATE_COLORS[i%5].bg,
        borderWidth: 2, pointRadius: 3,
        pointBackgroundColor: CANDIDATE_COLORS[i%5].border,
      }))
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{r:{min:50,max:100,ticks:{stepSize:10,font:{size:9}},pointLabels:{font:{size:11,weight:'600'}},grid:{color:'#e2e8f0'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:10}}}
    }
  });

  chartInstances.s1_bar = new Chart(document.getElementById('s1_bar'), {
    type: 'bar',
    data: {
      labels: candidates.map(c=>c.name),
      datasets: [{
        label:'ì¢…í•© ì ìˆ˜',
        data: candidates.map(c=>c.total_score),
        backgroundColor: candidates.map((c,i)=>CANDIDATE_COLORS[i%5].bg),
        borderColor: candidates.map((c,i)=>CANDIDATE_COLORS[i%5].border),
        borderWidth:2, borderRadius:6,
      }]
    },
    options: {
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      scales:{x:{min:600,max:1000,grid:{color:'#f1f5f9'},ticks:{font:{size:11}}},y:{ticks:{font:{size:12,weight:'600'}}}},
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.x}ì `}}}
    }
  });
}

function renderSection2Charts(candidates) {
  chartInstances.s2_grouped = new Chart(document.getElementById('s2_grouped'), {
    type: 'bar',
    data: {
      labels: METRICS.map(m=>METRIC_LABELS[m]),
      datasets: candidates.map((c,i)=>({
        label:c.name,
        data:METRICS.map(m=>c.metrics?.[m]??0),
        backgroundColor:CANDIDATE_COLORS[i%5].bg,
        borderColor:CANDIDATE_COLORS[i%5].border,
        borderWidth:2, borderRadius:3,
      }))
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{x:{ticks:{font:{size:10}},grid:{display:false}},y:{min:50,max:100,ticks:{font:{size:10}},grid:{color:'#f1f5f9'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}
    }
  });
}

function renderSection3Charts(candidates) {
  candidates.forEach((c, i) => {
    const col = CANDIDATE_COLORS[i%5];
    chartInstances[`s3_radar_${i}`] = new Chart(document.getElementById(`s3_radar_${i}`), {
      type: 'radar',
      data: {
        labels: METRICS.map(m=>METRIC_LABELS[m]),
        datasets: [{
          label:c.name,
          data:METRICS.map(m=>c.metrics?.[m]??0),
          borderColor:col.border, backgroundColor:col.bg,
          borderWidth:2, pointRadius:2, pointBackgroundColor:col.border,
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        scales:{r:{min:40,max:100,ticks:{display:false},pointLabels:{font:{size:9}},grid:{color:'#e2e8f0'}}},
        plugins:{legend:{display:false}}
      }
    });
  });
}

function renderSection4Charts(candidates, sortedC) {
  const leader = sortedC[0];
  const datasets = sortedC.slice(1).map(c=>({
    label:c.name,
    data:METRICS.map(m=>(c.metrics?.[m]??0)-(leader.metrics?.[m]??0)),
    backgroundColor:CANDIDATE_COLORS[c.idx%5].bg,
    borderColor:CANDIDATE_COLORS[c.idx%5].border,
    borderWidth:2, borderRadius:3,
  }));

  chartInstances.s4_gap = new Chart(document.getElementById('s4_gap'), {
    type:'bar',
    data:{labels:METRICS.map(m=>METRIC_LABELS[m]), datasets},
    options:{
      responsive:true, maintainAspectRatio:false, indexAxis:'y',
      scales:{
        x:{ticks:{callback:v=>v>0?'+'+v:v,font:{size:10}},grid:{color:ctx=>ctx.tick.value===0?'#94a3b8':'#f1f5f9'}},
        y:{ticks:{font:{size:11}}}
      },
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.x>0?'+'+ctx.parsed.x:ctx.parsed.x}ì `}}}
    }
  });
}

function renderSection5Charts(candidates) {
  const AI_BORDER_C = {claude:'#7c3aed',chatgpt:'#16a34a',gemini:'#2563eb',grok:'#dc2626'};

  chartInstances.s5_bar = new Chart(document.getElementById('s5_bar'), {
    type:'bar',
    data:{
      labels:candidates.map(c=>c.name),
      datasets:AI_MODELS.map(m=>({
        label:AI_LABELS[m],
        data:candidates.map(c=>c.ai_scores?.[m]??0),
        backgroundColor:AI_BORDER_C[m]+'30',
        borderColor:AI_BORDER_C[m],
        borderWidth:2, borderRadius:3,
      }))
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{x:{ticks:{font:{size:12}},grid:{display:false}},y:{min:650,max:900,ticks:{font:{size:10}},grid:{color:'#f1f5f9'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}
    }
  });

  chartInstances.s5_line = new Chart(document.getElementById('s5_line'), {
    type:'line',
    data:{
      labels:AI_MODELS.map(m=>AI_LABELS[m]),
      datasets:candidates.map((c,i)=>({
        label:c.name,
        data:AI_MODELS.map(m=>c.ai_scores?.[m]??0),
        borderColor:CANDIDATE_COLORS[i%5].border,
        backgroundColor:CANDIDATE_COLORS[i%5].bg,
        borderWidth:2, pointRadius:5, pointBackgroundColor:CANDIDATE_COLORS[i%5].border,
        tension:0.3,
      }))
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{x:{ticks:{font:{size:12,weight:'600'}}},y:{min:650,max:900,grid:{color:'#f1f5f9'}}},
      plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF ì €ì¥ (canvas â†’ img ë³€í™˜ í›„ ì¸ì‡„)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function savePDF() {
  const btn = document.querySelector('.pdf-btn');
  btn.disabled = true;
  btn.innerHTML = 'â³ ì°¨íŠ¸ ë³€í™˜ ì¤‘...';

  // ëª¨ë“  canvasë¥¼ ê³ í•´ìƒë„ imgë¡œ ë³€í™˜ (í™”ë©´ ë¹„ìœ¨ ê·¸ëŒ€ë¡œ ìœ ì§€)
  const canvasEls = Array.from(document.querySelectorAll('#fullReport canvas'));
  const replacements = [];

  for (const canvas of canvasEls) {
    try {
      // í™”ë©´ì— í‘œì‹œëœ ì‹¤ì œ í¬ê¸° ìº¡ì²˜
      const rect = canvas.getBoundingClientRect();
      const img = document.createElement('img');
      img.src = canvas.toDataURL('image/png', 1.0);
      img.className = 'chart-img';
      img.style.cssText = `
        width: 100%;
        height: ${rect.height}px;
        display: block;
        object-fit: contain;
      `;
      replacements.push({ canvas, img, parent: canvas.parentNode });
      canvas.parentNode.replaceChild(img, canvas);
    } catch(e) { console.warn('canvas ë³€í™˜ ì‹¤íŒ¨:', e); }
  }

  btn.innerHTML = 'ğŸ–¨ï¸ ì¸ì‡„ ì°½ ì—´ë¦¼...';

  // ë Œë”ë§ ì•ˆì •í™” ëŒ€ê¸°
  await new Promise(r => setTimeout(r, 600));
  window.print();

  // ì¸ì‡„ í›„ canvas ë³µì›
  setTimeout(() => {
    replacements.forEach(({ img, canvas, parent }) => {
      try {
        if (img.parentNode === parent) parent.replaceChild(canvas, img);
      } catch(e) {}
    });
    btn.disabled = false;
    btn.innerHTML = 'ğŸ“¥ PDFë¡œ ì €ì¥';
  }, 1500);
}
</script>
</body>
</html>
